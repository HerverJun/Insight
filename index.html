<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight ¬∑ ÁßãÊØ´V4</title>
    <style>
        :root {
            /* Ê†∏ÂøÉËâ≤Êùø - ÈõÖÈüµ (Elegant Ink) - 2.0 */
            --primary: #00897B;
            --primary-light: #4DB6AC;
            --primary-dark: #004D40;
            --primary-accent: #00BFA5;
            /* ÁêâÁíÉÈùí (Glazed Blue) */
            --gold-accent: #C9A962;
            /* ÈéèÈáë (Gold Thread) */

            /* Backgrounds */
            --bg-body: #F4F6F8;
            --bg-card: #FFFFFF;
            --bg-subtle: #F8FAFC;

            /* Text */
            --text-main: #1F2937;
            /* Â¢®ÁÅ∞ */
            --text-sub: #64748B;
            /* Áü≥ÊùøÁÅ∞ */
            --text-light: #94A3B8;

            /* Functional */
            --border-color: #E2E8F0;
            --border-hover: #CBD5E1;
            /* Â§öÂ±ÇÂΩ©Ëâ≤Èò¥ÂΩ±Á≥ªÁªü */
            --shadow-sm: 0 1px 2px rgba(0, 137, 123, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 137, 123, 0.05), 0 2px 4px -1px rgba(0, 137, 123, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 137, 123, 0.08), 0 4px 6px -2px rgba(0, 137, 123, 0.04);
            --shadow-glow: 0 0 20px rgba(0, 137, 123, 0.15);

            --sidebar-width: 260px;

            /* Status */
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;

            /* Transitions */
            --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Â≠ó‰Ωì‰ºòÂåñ */
            font-family: "Inter", "PingFang SC", "Microsoft YaHei UI", system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            /* ÂÆ£Á∫∏Á∫πÁêÜ + Âä®ÊÄÅÂÖâÊôï */
            background-image:
                radial-gradient(circle at 0% 0%, rgba(0, 137, 123, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(201, 169, 98, 0.05) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.03' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1'/%3E%3Ccircle cx='13' cy='13' r='1'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Sidebar Styles - ÁÆÄÁ∫¶ÈõÖËá¥ (Elegant Simple) */
        /* Sidebar Styles - Ê∏ÖÊñ∞Â±ÇÊ¨° (Clean Layer) */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
            padding: 32px 24px;
            z-index: 10;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.015);
        }

        .brand {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 48px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s var(--ease-out);
            color: var(--text-sub);
            font-weight: 500;
            font-size: 14px;
            background: transparent;
            border: 1px solid transparent;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(0, 137, 123, 0.04);
            color: var(--primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: rgba(0, 137, 123, 0.08);
            color: var(--primary);
            font-weight: 600;
        }

        /* ÈÄâ‰∏≠Êó∂ÁöÑÂ∑¶‰æßÊåáÁ§∫Êù° (ÂèØÈÄâËÆæËÆ°ÔºåËøôÈáåÁî®ËÉåÊôØËâ≤Âå∫ÂàÜÂ∑≤Ë∂≥Â§üÔºåÊàñËÄÖÂä†‰∏Ä‰∏™Â∞èÂúÜÁÇπ) */
        /*
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 0 4px 4px 0;
        }
        */

        .nav-icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            transition: all 0.3s ease;
        }

        .nav-item:hover .nav-icon {
            transform: rotate(5deg);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            position: relative;
            background: transparent;
            /* ÈÄèÊòéËÉåÊôØÔºåÈÄèÂá∫bodyÁöÑÂÆ£Á∫∏Á∫πÁêÜ */
        }

        /* Custom Scrollbar */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #B0BEC5;
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        .view-container {
            display: none;
            height: 100%;
            flex-direction: column;
            gap: 24px;
            animation: fadeScale 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .view-container.active {
            display: flex;
        }

        @keyframes fadeScale {
            from {
                opacity: 0;
                transform: scale(0.99);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Configuration Layout */
        .config-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            /* Fixed Left, Fluid Right */
            gap: 24px;
            height: 100%;
        }

        .panel-col {
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 100%;
        }

        /* Modern Cards - Elegant Style */
        /* Modern Cards - Elegant Style */
        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.9);
            box-shadow: var(--shadow-lg);
            background: rgba(255, 255, 255, 0.85);
        }

        .card.fill-height {
            flex: 1;
            overflow: hidden;
        }

        .card-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            /* Á´πÈùíËâ≤Ë£ÖÈ•∞Êù° */
            background: var(--primary);
            border-radius: 2px;
            margin-right: 12px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-sub);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.6);
            color: var(--text-main);
            font-size: 14px;
            transition: all 0.25s ease;
            font-family: inherit;
        }

        .form-control:focus {
            background: #FFFFFF;
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px var(--shadow-glow);
        }

        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        /* Buttons - Elegant Style */
        .btn {
            border: 1px solid transparent;
            cursor: pointer;
            padding: 10px 22px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-accent));
            color: #fff;
            box-shadow: 0 4px 12px rgba(0, 137, 123, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 137, 123, 0.35);
        }

        .btn-secondary {
            background: #FFFFFF;
            color: var(--text-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #FAFAFA;
        }

        .btn-danger {
            background: linear-gradient(145deg, #EF5350, #C62828);
            color: white;
            box-shadow: 0 2px 6px rgba(198, 40, 40, 0.2);
        }

        .btn-danger:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
        }

        .btn-icon {
            padding: 10px;
        }

        /* Checklist */
        .checklist-container {
            border: 1px solid var(--border-color);
            background: #FAFAFA;
            border-radius: 8px;
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        /* Custom Scrollbar for Checklist */
        .checklist-container::-webkit-scrollbar {
            width: 6px;
        }

        .checklist-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .checklist-container::-webkit-scrollbar-thumb {
            background: #CFD8DC;
            border-radius: 3px;
        }

        .checklist-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #FFFFFF;
            border: 1px solid transparent;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .checklist-item:hover {
            border-color: var(--primary-light);
            background: #F0FDF4;
            /* ÊûÅÊ∑°ÁöÑÁªøËâ≤ËÉåÊôØ */
        }

        .checklist-item input {
            margin-right: 12px;
            accent-color: var(--primary);
            width: 16px;
            height: 16px;
            transition: all 0.2s ease;
        }

        .checklist-item input:checked {
            /* ÊµèËßàÂô®ÈªòËÆ§Ë°å‰∏∫Âç≥ÂèØÔºåÈÖçÂêà accent-color */
        }

        .checklist-item label {
            font-size: 14px;
            color: var(--text-main);
            cursor: pointer;
            flex: 1;
        }

        /* Grid for Params */
        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        /* Switches */
        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #F9FAFB;
            /* ÊµÖÁÅ∞ËÉåÊôØ */
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .switch-row span {
            white-space: nowrap;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-main);
        }

        .switch {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
            /* Èò≤Ê≠¢ÂºÄÂÖ≥Ë¢´ÂéãÁº© */
            margin-left: 12px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #CFD8DC;
            transition: all 0.3s ease;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: all 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background: var(--primary);
            box-shadow: none;
        }

        input:checked+.slider:before {
            transform: translateX(18px);
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Monitor View - Elegant Theme */
        .monitor-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .kpi-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-light);
            box-shadow: 0 8px 20px rgba(0, 137, 123, 0.08);
        }

        .kpi-title {
            font-size: 13px;
            color: var(--text-sub);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-top: 8px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            letter-spacing: -0.5px;
            text-shadow: none;
        }

        .chart-row {
            flex: 1;
            background: #FFFFFF;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
            min-height: 0;
            position: relative;
        }

        .log-row {
            height: 200px;
            background: #263238;
            /* ‰øùÊåÅÊ∑±Ëâ≤ÁªàÁ´ØÊÑüÔºåÂØπÊØîÂº∫ÁÉà */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .console-log {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #CFD8DC;
            background: transparent;
        }

        /* Custom Scrollbar for Console */
        .console-log::-webkit-scrollbar {
            width: 6px;
        }

        .console-log::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .console-log::-webkit-scrollbar-thumb {
            background: #546E7A;
            border-radius: 3px;
        }

        .status-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #B0BEC5;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Modal - Elegant Style */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(38, 50, 56, 0.6);
            /* Ê∑±Ëâ≤ÈÅÆÁΩ© */
            backdrop-filter: blur(4px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: #FFFFFF;
            width: 500px;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: none;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Success Notification Toast - Elegant Style */
        .success-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: #FFFFFF;
            padding: 40px 60px;
            border-radius: 16px;
            z-index: 200;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid #E0E0E0;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        .success-toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .success-toast-icon {
            font-size: 64px;
            margin-bottom: 24px;
            animation: bounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: none;
            /* ÁßªÈô§ÂèëÂÖâ */
        }

        .success-toast-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 12px;
            text-shadow: none;
        }

        .success-toast-message {
            font-size: 15px;
            color: var(--text-sub);
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .success-toast-close {
            background: var(--success);
            border: none;
            padding: 12px 40px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(56, 142, 60, 0.2);
        }

        .success-toast-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 142, 60, 0.3);
            filter: brightness(1.1);
        }

        @keyframes bounce {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .success-toast-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(38, 50, 56, 0.5);
            backdrop-filter: blur(2px);
            z-index: 199;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .success-toast-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Log Styles */
        .log-item {
            margin-bottom: 4px;
            padding: 2px 0;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }

        .log-time {
            color: #78909C;
            margin-right: 10px;
        }

        .log-info {
            color: #CFD8DC;
        }

        .log-error {
            color: #EF5350;
        }

        .log-success {
            color: #66BB6A;
        }

        .log-warning {
            color: #FFA726;
        }

        /* Progress Bar */
        .progress-bar {
            transition: width 0.3s ease;
            background: var(--primary);
            box-shadow: none;
        }

        /* Table Styles - Elegant Ledger */
        .training-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            color: var(--text-main);
            font-size: 14px;
        }

        .training-table th {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            /* Âä†ÈáçÊ†áÈ¢òÁ∫ø */
            color: var(--text-sub);
            font-weight: 600;
        }

        .training-table td {
            padding: 14px 12px;
            border-bottom: 1px dashed var(--border-color);
            /* ËôöÁ∫øÂàÜÈöî */
            transition: all 0.2s;
        }

        .training-table tr:last-child td {
            border-bottom: none;
        }

        .training-table tr:hover td {
            background: rgba(0, 137, 123, 0.03);
            /* ÊûÅÊ∑°ÁöÑÈùíËâ≤ÊÇ¨ÂÅú */
        }

        /* Mini Toast - Âè≥‰∏äËßíÈÄöÁü•Ê†è */
        .mini-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00897B, #26A69A);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 300;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px rgba(0, 137, 123, 0.3);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 400px;
        }

        .mini-toast.show {
            transform: translateX(0);
        }

        .mini-toast-icon {
            font-size: 24px;
        }

        .mini-toast-content {
            flex: 1;
        }

        .mini-toast-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .mini-toast-message {
            font-size: 12px;
            opacity: 0.9;
            word-break: break-all;
        }

        /* ========== Phase 5: Animations & Micro-interactions ========== */

        /* 1. View Transitions */
        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.99);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .view-container.active {
            animation: fadeSlideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* 2. Staggered Entry Animations */
        @keyframes staggerReveal {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-item {
            opacity: 0;
            /* Initially hidden */
            animation: staggerReveal 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* 3. Enhanced Hover Effects */
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: scale(0.96);
        }

        .checklist-item {
            transition: all 0.2s ease;
        }

        .checklist-item:hover {
            transform: translateX(4px);
            background: #F0FDF4;
        }

        .form-control:focus {
            transform: translateY(-1px);
        }

        /* Labeling View Styles */
        .labeling-layout {
            display: flex;
            gap: 16px;
            height: 100%;
        }

        .labeling-sidebar {
            width: 220px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .labeling-panel {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .labeling-canvas-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .labeling-toolbar {
            height: 50px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            z-index: 5;
        }

        .canvas-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            /* cursor: crosshair; set dynamicaly */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e0e0e0;
            background-image:
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        #labelingCanvas {
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.15);
            /* canvas size handled by js */
        }

        .image-list-container {
            flex: 1;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .image-list-item {
            padding: 10px 14px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-sub);
            transition: all 0.2s;
        }

        .image-list-item:hover {
            background: rgba(0, 137, 123, 0.05);
            color: var(--primary);
        }

        .image-list-item.active {
            background: rgba(0, 137, 123, 0.1);
            color: var(--primary-dark);
            font-weight: 600;
            border-left: 3px solid var(--primary);
        }

        .image-list-item.done .status-icon {
            color: var(--success);
        }

        .label-chip {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            background: #FFFFFF;
            margin-bottom: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
            justify-content: space-between;
        }

        .label-chip:hover {
            border-color: var(--border-hover);
            transform: translateX(2px);
        }

        .label-chip.active {
            border-color: var(--primary);
            background: #E0F2F1;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid transparent;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-main);
            transition: all 0.2s;
            font-weight: 500;
        }

        .toolbar-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .toolbar-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 137, 123, 0.3);
        }

        .toolbar-info {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-light);
            font-family: Consolas, monospace;
        }

        .toolbar-sep {
            width: 1px;
            height: 24px;
            background: rgba(0, 0, 0, 0.1);
            margin: 0 4px;
        }

        .shortcut-hint {
            opacity: 0.6;
            font-size: 11px;
            margin-left: 4px;
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <!-- Logo Icon as Linear SVG -->
        <div class="brand">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
            Insight ¬∑ ÁßãÊØ´
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('config')" id="nav-config">
                <!-- Config Icon -->
                <svg class="nav-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                <span>‰ªªÂä°ÈÖçÁΩÆ</span>
            </div>
            <div class="nav-item" onclick="switchTab('monitor')" id="nav-monitor">
                <!-- Monitor/Chart Icon -->
                <svg class="nav-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                <span>ËÆ≠ÁªÉÁõëÊéß</span>
            </div>
            <div class="nav-item" onclick="switchTab('tools')" id="nav-tools">
                <!-- Tools Icon -->
                <svg class="nav-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                    </path>
                </svg>
                <span>Êï∞ÊçÆËΩ¨Êç¢</span>
            </div>
            <div class="nav-item" onclick="switchTab('labeling')" id="nav-labeling">
                <!-- Labeling Icon (Bounding Box with Plus) -->
                <svg class="nav-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                <span>Êô∫ËÉΩÊ†áÊ≥®</span>
            </div>
            <div class="nav-item" onclick="switchTab('models')" id="nav-models">
                <!-- Models/Archive Icon -->
                <svg class="nav-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="21 8 21 21 3 21 3 8"></polyline>
                    <rect x="1" y="3" width="22" height="5"></rect>
                    <line x1="10" y1="12" x2="14" y2="12"></line>
                </svg>
                <span>ËÆ≠ÁªÉÂéÜÂè≤</span>
            </div>
        </div>
        <div style="flex: 1;"></div>
        <div style="font-size: 11px; color: var(--text-light); text-align: center; margin-top: 20px;">v2.1.0</div>
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <!-- View: Configuration -->
        <div id="view-config" class="view-container active">
            <div class="config-layout">
                <!-- Left Column: Data Source Mgmt -->
                <div class="panel-col">
                    <div class="card fill-height">
                        <div class="card-header">
                            <span>È°πÁõÆ‰∏éÊï∞ÊçÆÊ∫ê</span>
                            <div style="display: flex; gap: 6px;">
                                <button class="btn btn-secondary btn-icon" onclick="loadProjects()" title="Âà∑Êñ∞È°πÁõÆ">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15">
                                        </path>
                                    </svg>
                                </button>
                                <button class="btn btn-primary btn-icon" onclick="openCreateProjectModal()"
                                    title="Êñ∞Âª∫È°πÁõÆ">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </button>
                                <button class="btn btn-danger btn-icon" onclick="deleteProject()" title="Âà†Èô§ÂΩìÂâçÈ°πÁõÆ">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path
                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                        </path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-group"><label class="form-label">ÂΩìÂâçÈ°πÁõÆ (Project)</label><select
                                id="projectSelect" class="form-control" onchange="onProjectChanged()">
                                <option value="">Ê≠£Âú®Âä†ËΩΩ...</option>
                            </select></div>
                        <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                            <label class="form-label">Êï∞ÊçÆÊ∫êÂä†ËΩΩ (Checklist)</label>
                            <div id="dataSourceList" class="checklist-container">
                                <div style="text-align: center; padding: 20px; color: #aaa; font-size: 13px;">
                                    ËØ∑ÈÄâÊã©È°πÁõÆ </div>
                            </div>
                        </div>
                        <div class="form-group"><label class="form-label">ËæìÂá∫Ë∑ØÂæÑ (Workspace)</label><input type="text"
                                id="targetPath" class="form-control" readonly style="font-size: 12px; opacity: 0.8;">
                        </div>
                    </div>
                </div>
                <!-- Right Column: Training Params -->
                <div class="panel-col">
                    <div class="card">
                        <div class="card-header">
                            <span>YOLO ËÆ≠ÁªÉÂèÇÊï∞</span>
                            <button class="btn btn-secondary" onclick="openAugmentModal()"
                                style="font-size: 13px; padding: 6px 12px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    style="margin-right: 6px;">
                                    <path
                                        d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                                    </path>
                                </svg>
                                Áº∫Èô∑Â¢ûÂº∫
                            </button>
                        </div>
                        <div class="params-grid">
                            <div class="form-group"><label class="form-label">Ê®°ÂûãÂ§ßÂ∞è</label><select id="modelSize"
                                    class="form-control">
                                    <optgroup label="YOLOv8">
                                        <option value="v8n">Nano (v8n)</option>
                                        <option value="v8s" selected>Small (v8s)</option>
                                        <option value="v8m">Medium (v8m)</option>
                                        <option value="v8l">Large (v8l)</option>
                                    </optgroup>
                                    <optgroup label="YOLOv11">
                                        <option value="v11n">Nano (v11n)</option>
                                        <option value="v11s">Small (v11s)</option>
                                        <option value="v11m">Medium (v11m)</option>
                                    </optgroup>
                                    <optgroup label="YOLO26">
                                        <option value="v26n">Nano (v26n)</option>
                                        <option value="v26s">Small (v26s)</option>
                                        <option value="v26m">Medium (v26m)</option>
                                        <option value="v26l">Large (v26l)</option>
                                        <option value="v26x">X-Large (v26x)</option>
                                    </optgroup>
                                </select></div>
                            <div class="form-group"><label class="form-label">ÂõæÁâáÂ∞∫ÂØ∏
                                    (ImgSz)</label><input type="number" id="imgSize" class="form-control" value="640"
                                    step="32"></div>
                            <div class="form-group"><label class="form-label">Batch
                                    Size</label><input type="number" id="batchSize" class="form-control" value="16"
                                    placeholder="Auto (-1)"></div>
                            <div class="form-group"><label class="form-label">Epochs</label><input type="number"
                                    id="epochs" class="form-control" value="300">
                            </div>
                            <div class="form-group"><label class="form-label">Patience</label><input type="number"
                                    id="patience" class="form-control" value="50">
                            </div>
                            <div class="form-group"><label class="form-label">Worker
                                    Threads</label><input type="number" id="workers" class="form-control" value="8">
                            </div>
                            <div class="form-group"><label class="form-label">GPU
                                    Index</label><input type="text" id="gpuIndex" class="form-control" value="0">
                            </div>
                        </div>
                        <div class="params-grid" style="margin-top: 10px;">
                            <div class="switch-row">
                                <span>P2 Â∞èÁõÆÊ†áÂ¢ûÂº∫</span>
                                <label class="switch"><input type="checkbox" id="enableP2"><span
                                        class="slider"></span></label>
                            </div>
                            <div class="switch-row">
                                <span>Ëá™Âä®‰øÆÊ≠£ÂõæÁâá</span>
                                <label class="switch"><input type="checkbox" id="autoFixImage" checked><span
                                        class="slider"></span></label>
                            </div>
                        </div>

                        <!-- Model Management Config -->
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                            <div class="params-grid">
                                <div class="form-group">
                                    <label class="form-label">Ëá™ÂÆö‰πâÊ®°ÂûãÂêçÁß∞ (ONNX Name) <span
                                            style="color: var(--text-sub); font-weight: normal; font-size: 12px;">(‰∏∫Á©∫ÂàôËá™Âä®ÂëΩÂêç)</span></label>
                                    <input type="text" id="customOnnxName" class="form-control"
                                        placeholder="‰æãÂ¶Ç: MyModel-v1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ê®°Âûã‰øùÂ≠òÁõÆÂΩï (Storage Path)</label>
                                    <div class="input-group">
                                        <input type="text" id="modelStoragePath" class="form-control" readonly
                                            placeholder="ÈªòËÆ§: È°πÁõÆÊ†πÁõÆÂΩï/models">
                                        <button class="btn btn-secondary"
                                            onclick="selectFolder('modelStorage')">üìÅ</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 24px;"><button id="btnGenerate" class="btn btn-primary"
                                onclick="startGenerate()" style="width: 100%;">‚ú® ÁîüÊàêÊï∞ÊçÆÈõÜ (Generate) </button>
                            <div id="statusMessage"
                                style="text-align: center; margin-top: 10px; font-size: 13px; color: var(--text-sub); height: 20px;">
                            </div>
                            <!-- Status Grid -->

                        </div>
                    </div>
                    <div class="card" style="flex: 0;">
                        <div class="card-header"><span>ÊâßË°åÊéßÂà∂</span></div>
                        <div class="form-group">
                            <div class="input-group"><input type="text" id="pythonPath" class="form-control"
                                    value="C:\conda_envs\yolo\python.exe" placeholder="Python Environment Path..."
                                    onchange="savePythonPath(this.value)"><button class="btn btn-secondary"
                                    onclick="selectFolder('python')" title="ÊµèËßàÊñá‰ª∂Â§π">üìÅ</button><button
                                    class="btn btn-secondary" onclick="saveAsDefaultPythonPath()" title="‰øùÂ≠ò‰∏∫ÈªòËÆ§Âú∞ÂùÄ"
                                    style="margin-left: 4px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="margin-right: 4px;">
                                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z">
                                        </path>
                                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                        <polyline points="7 3 7 8 15 8"></polyline>
                                    </svg>
                                    ËÆæ‰∏∫ÈªòËÆ§
                                </button></div>
                        </div>
                        <div style="display: flex; gap: 16px;">
                            <button id="btnStartTrain" class="btn btn-primary" onclick="startTraining()"
                                style="flex: 2;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    style="margin-right: 6px;">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                ÂºÄÂßãËÆ≠ÁªÉ
                            </button>
                            <button id="btnStopTrain" class="btn btn-danger" onclick="stopTraining()" disabled
                                style="flex: 1;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    style="margin-right: 6px;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                </svg>
                                ÂÅúÊ≠¢
                            </button>
                            <button id="btnOpenOutput" class="btn btn-secondary" onclick="openOutputFolder()"
                                style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    style="margin-right: 6px;">
                                    <path
                                        d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z">
                                    </path>
                                </svg>
                                ÁªìÊûú
                            </button>
                        </div>
                    </div>
                    <!-- Layout Optimization: System Status & Mini Log -->
                    <!-- Flex-grow to fill the remaining vertical space -->
                    <div class="card" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div class="card-header"><span>Á≥ªÁªüÁä∂ÊÄÅ (System Status)</span><span
                                style="font-size: 11px; color: var(--text-sub);">Live</span>
                        </div>
                        <!-- Status Grid -->
                        <!-- Status Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                            <div
                                style="background: rgba(0, 137, 123, 0.04); padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(0, 137, 123, 0.1);">
                                <div
                                    style="width: 32px; height: 32px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00897B"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M12 19c-4.4 0-8-3.6-8-8 0-4.4 3.6-8 8-8 4.4 0 8 3.6 8 8 0 4.4-3.6 8-8 8z">
                                        </path>
                                        <path d="M12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path>
                                    </svg>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; color: var(--text-sub); font-weight: 500;">Python
                                        Env
                                    </div>
                                    <div style="font-size: 13px; font-weight: 700; color: var(--success);">Detected
                                    </div>
                                </div>
                            </div>
                            <div
                                style="background: rgba(0, 137, 123, 0.04); padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(0, 137, 123, 0.1);">
                                <div
                                    style="width: 32px; height: 32px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00897B"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                                        <line x1="6" y1="6" x2="6.01" y2="6"></line>
                                        <line x1="6" y1="18" x2="6.01" y2="18"></line>
                                    </svg>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; color: var(--text-sub); font-weight: 500;">GPU
                                        Status
                                    </div>
                                    <div style="font-size: 13px; font-weight: 700; color: var(--success);"
                                        id="gpuStatus">Ready</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- View: Monitor -->
        <div id="view-monitor" class="view-container">
            <div class="monitor-layout">
                <!-- KPI Cards -->
                <div class="kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38" />
                            </svg>
                            Epochs
                        </div>
                        <div class="kpi-value" id="kpi-epoch">0/0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#d98e84"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            Box Loss
                        </div>
                        <div class="kpi-value" id="kpi-loss" style="color: #d98e84;">0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8cb6a8"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            mAP50
                        </div>
                        <div class="kpi-value" id="kpi-map50" style="color: #8cb6a8;">0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#e6c587"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon
                                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                                </polygon>
                            </svg>
                            mAP50-95
                        </div>
                        <div class="kpi-value" id="kpi-map95" style="color: #e6c587;">0.00</div>
                        <div style="position: absolute; right: 20px; bottom: 20px; opacity: 0.1;">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#e6c587"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>
                <!-- Main Chart -->
                <div class="chart-row"><canvas id="trainingChart"></canvas></div>
                <!-- Terminal & Progress -->
                <div class="log-row">
                    <div class="status-header">
                        <div style="display:flex; gap:15px;"><span id="progressStatus">Ready</span><span
                                id="progressETA" style="color: #0be881;"></span></div><span
                            id="progressPercent">0%</span>
                    </div>
                    <div style="height: 4px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar" id="progressFill" style="height:100%; width:0%; background:#0be881;">
                        </div>
                    </div>
                    <div class="console-log" id="console">
                        <div class="log-item"><span class="log-time">[System]</span>Ready to train.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- View: Tools (Data Converter) -->
        <div id="view-tools" class="view-container">
            <div class="card">
                <div class="card-header"><span>LabelMe ËΩ¨ YOLO (Converter)</span></div>
                <div class="form-group"><label class="form-label">Ê∫êÊñá‰ª∂Â§πË∑ØÂæÑ (LabelMe JSONs +
                        Images)</label>
                    <div class="input-group"><input type="text" id="toolSourcePath" class="form-control"
                            placeholder="ÈÄâÊã©ÂåÖÂê´ JSON ÂíåÂõæÁâáÁöÑÊñá‰ª∂Â§π..."><button class="btn btn-secondary"
                            onclick="selectFolder('toolSource')">üìÅ</button></div>
                </div>
                <div class="form-group"><label class="form-label">ÁõÆÊ†á‰øùÂ≠òË∑ØÂæÑ (Output Folder)</label>
                    <div class="input-group"><input type="text" id="toolTargetPath" class="form-control"
                            placeholder="ÈÄâÊã©ËΩ¨Êç¢ÁªìÊûú‰øùÂ≠ò‰ΩçÁΩÆ..."><button class="btn btn-secondary"
                            onclick="selectFolder('toolTarget')">üìÅ</button></div>
                </div>
                <div style="margin-top: 24px;"><button class="btn btn-primary" onclick="startToolConversion()"
                        style="width: 100%;">üöÄ ÂºÄÂßãËΩ¨Êç¢ (Start
                        Conversion) </button></div>
            </div>
            <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                <div class="card-header"><span>ËΩ¨Êç¢Êó•Âøó (Log)</span></div>
                <div class="console-log" id="toolConsole" style="background: #1e272e; border-radius: 12px;">
                    <div class="log-item"><span class="log-time">[System]</span>Ready for
                        conversion.</div>
                </div>
            </div>
        </div>

        <!-- View: Training History (Simplified) -->
        <div id="view-models" class="view-container">
            <div class="card fill-height">
                <div class="card-header">
                    <span>ËÆ≠ÁªÉÂéÜÂè≤ (Training History)</span>
                    <button class="btn btn-secondary btn-icon" onclick="loadTrainingHistory()" title="Âà∑Êñ∞ÂéÜÂè≤">üîÑ</button>
                </div>

                <div class="checklist-container">
                    <table class="training-table">
                        <thead>
                            <tr>
                                <th>È°πÁõÆ (Project)</th>
                                <th>ÈÖçÁΩÆ (Config)</th>
                                <th>ËÆ≠ÁªÉÊåáÊ†á (Metrics)</th>
                                <th style="width: 150px;">Êó∂Èó¥ (Date)</th>
                                <th style="width: 60px; text-align: center;">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="trainingHistoryBody">
                            <!-- Training history entries will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- View: Labeling (SAM2) -->
        <div id="view-labeling" class="view-container">
            <div class="labeling-layout">
                <!-- Sidebar -->
                <div class="labeling-sidebar">
                    <div class="card fill-height">
                        <div class="card-header">
                            <span>ÂõæÁâáÂàóË°®</span>
                            <button class="btn btn-secondary btn-icon" onclick="openLabelingFolder()" title="ÊâìÂºÄÊñá‰ª∂Â§π"
                                style="padding:4px; width:28px; height:28px;">üìÅ</button>
                        </div>
                        <div class="image-list-container" id="labelingImageList">
                            <div style="padding: 20px; text-align: center; color: #aaa;">ËØ∑ÂÖàÊâìÂºÄÊñá‰ª∂Â§π</div>
                        </div>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="labeling-canvas-area">
                    <!-- Toolbar -->
                    <div class="labeling-toolbar">
                        <button class="toolbar-btn active" id="tool-auto" onclick="setLabelingMode('auto')"
                            title="Êô∫ËÉΩÊ†áÊ≥® (SAM)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                            </svg>
                            Ëá™Âä® <span class="shortcut-hint">(Q)</span>
                        </button>
                        <button class="toolbar-btn" id="tool-rect" onclick="setLabelingMode('rect')" title="ÊâãÂä®Áü©ÂΩ¢Ê°Ü">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            </svg>
                            Áü©ÂΩ¢ <span class="shortcut-hint">(R)</span>
                        </button>
                        <div class="toolbar-sep"></div>
                        <button class="toolbar-btn" onclick="labelingAction('undo')" title="Êí§ÈîÄ‰∏ä‰∏Ä‰∏™ÁÇπ/Ê°Ü (Ctrl+Z)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 7v6h6"></path>
                                <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
                            </svg>
                        </button>
                        <button class="toolbar-btn" onclick="labelingAction('clear')" title="Ê∏ÖÈô§ÂΩìÂâçÊú™ÂÆåÊàê (Esc/B)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Ê∏ÖÈô§ <span class="shortcut-hint">(B)</span>
                        </button>
                        <button class="toolbar-btn" onclick="labelingAction('complete')" title="ÂÆåÊàêÂΩìÂâçÊ†áÊ≥® (Enter/F)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            ÂÆåÊàê <span class="shortcut-hint">(F)</span>
                        </button>

                        <div class="toolbar-info" id="canvasInfo">Loading...</div>
                    </div>

                    <!-- Canvas -->
                    <div class="canvas-wrapper" id="canvasWrapper">
                        <canvas id="labelingCanvas"></canvas>
                    </div>

                    <!-- Bottom Bar -->
                    <div
                        style="height: 48px; background: rgba(255,255,255,0.9); border-top: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; padding: 0 16px;">
                        <button class="btn btn-secondary" onclick="prevImage()">‚Üê (A)</button>
                        <span style="font-size: 13px; font-weight: 600; color: var(--text-main); font-family: Consolas;"
                            id="currentImageName">-</span>
                        <button class="btn btn-secondary" onclick="nextImage()">(D) ‚Üí</button>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="labeling-panel">
                    <!-- Label List -->
                    <div class="card"
                        style="flex: 1; overflow: hidden; display: flex; flex-direction: column; min-height: 200px;">
                        <div class="card-header">
                            <span>ÂàÜÁ±ª (Classes)</span>
                            <button class="btn btn-secondary btn-icon" onclick="addLabel()"
                                style="padding: 4px; width: 24px; height: 24px;">+</button>
                        </div>
                        <div style="flex: 1; overflow-y: auto; padding-right: 4px;" id="labelListContainer">
                            <!-- Labels -->
                        </div>
                    </div>

                    <!-- Annotations List -->
                    <div class="card"
                        style="flex: 1; overflow: hidden; display: flex; flex-direction: column; min-height: 200px;">
                        <div class="card-header"><span>Ê†áÊ≥® (Objects)</span></div>
                        <div style="flex: 1; overflow-y: auto;" id="annotationListContainer">
                            <!-- Current Annotations -->
                        </div>
                    </div>

                    <!-- Model Settings -->
                    <div class="card">
                        <div class="card-header"><span>Ê®°ÂûãËÆæÁΩÆ</span></div>
                        <div class="form-group">
                            <label class="form-label">Ê®°Âûã</label>
                            <select class="form-control" id="samModelSelect">
                                <option value="sam2.1_hiera_tiny">SAM2.1 Tiny (Êé®Ëçê)</option>
                            </select>
                        </div>
                        <div class="switch-row" style="padding: 8px 0; border: none; background: transparent;">
                            <span style="font-size: 13px;">GPU Âä†ÈÄü</span>
                            <label class="switch">
                                <input type="checkbox" id="samUseGpu" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group" style="margin-top: 8px;">
                            <label class="form-label">ÈòàÂÄº (ÁÅµÊïèÂ∫¶) <span id="thresholdValue"
                                    style="color: var(--primary); font-weight: bold;">0.0</span></label>
                            <input type="range" id="samThreshold" min="-5" max="5" step="0.5" value="0"
                                style="width: 100%; cursor: pointer;"
                                oninput="document.getElementById('thresholdValue').innerText = parseFloat(this.value).toFixed(1)">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 2px;">
                                <span>ÂÆΩÊùæ (-5)</span>
                                <span>‰∏•Ê†º (+5)</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="btnLoadModel" onclick="loadSAMModel()"
                            style="width: 100%; margin-top: 8px;">
                            ‚ö° Âä†ËΩΩÊ®°Âûã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-bottom: 24px; color: var(--text-main);">Êñ∞Âª∫È°πÁõÆ
                (Create Project)</h3>
            <div class="form-group"><label class="form-label">È°πÁõÆÂêçÁß∞ (Name)</label><input type="text" id="newProjectName"
                    class="form-control" placeholder="‰æãÂ¶Ç: Screw Detection"></div>
            <div class="form-group"><label class="form-label">È°πÁõÆÊ†πÁõÆÂΩï (Root Path)</label>
                <div class="input-group"><input type="text" id="newProjectRoot" class="form-control" readonly
                        placeholder="ÈÄâÊã©Á©∫Êñá‰ª∂Â§πÊàñÁé∞ÊúâÊï∞ÊçÆÊñá‰ª∂Â§π..."><button class="btn btn-secondary"
                        onclick="selectFolder('newProjectRoot')">üìÅ</button></div>
            </div>
            <div class="form-group"><label class="form-label">ÂåÖÂê´Á±ªÂà´ (Classes)</label><input type="text"
                    id="newProjectClasses" class="form-control" placeholder="Áî®ÈÄóÂè∑ÂàÜÈöî, ‰æãÂ¶Ç: screw, nut, ng">
                <p style="font-size: 12px; color: #999; margin-top: 4px;">* ÂØπÂ∫î YOLO data.yaml ‰∏≠ÁöÑ names</p>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;"><button
                    class="btn btn-secondary" onclick="closeCreateProjectModal()">ÂèñÊ∂à</button><button
                    class="btn btn-primary" onclick="createProject()">ÂàõÂª∫</button></div>
        </div>
    </div>
    <!-- Modals -->
    <div id="augmentModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-bottom: 24px; color: var(--primary); text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);">
                Áº∫Èô∑Ê†∑Êú¨Â¢ûÂº∫
            </h3>
            <div class="form-group"><label class="form-label">Ê∫êË∑ØÂæÑ (Source)</label>
                <div class="input-group"><input type="text" id="augmentSourcePath" class="form-control" readonly><button
                        class="btn btn-secondary" onclick="selectFolder('augmentSource')">üìÅ</button></div>
            </div>
            <div class="form-group"><label class="form-label">Á¥†ÊùêË∑ØÂæÑ (Defect Assets)</label>
                <div class="input-group"><input type="text" id="holeAssetsPath" class="form-control" readonly><button
                        class="btn btn-secondary" onclick="selectFolder('holeAssets')">üìÅ</button>
                </div>
            </div>
            <div class="form-group"><label class="form-label">ÁîüÊàêÊØî‰æã: <span id="mutationRateVal">30%</span></label><input
                    type="range" id="mutationRate" style="width: 100%; accent-color: var(--primary);" min="10" max="80"
                    value="30" oninput="document.getElementById('mutationRateVal').innerText = this.value + '%'">
            </div>
            <div style="background: #f5f5f5; border-radius: 8px; height: 6px; overflow: hidden; margin: 20px 0;">
                <div id="augmentFill"
                    style="background: var(--primary); width: 0%; height: 100%; transition: width 0.3s;">
                </div>
            </div>
            <div id="augmentStatus"
                style="font-size: 12px; color: var(--text-sub); margin-bottom: 20px; text-align: center;">
                Wait</div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;"><button class="btn btn-secondary"
                    onclick="closeAugmentModal()">ÂèñÊ∂à</button><button class="btn btn-primary"
                    onclick="startAugmentation()">ÂºÄÂßãÁîüÊàê</button></div>
        </div>
    </div>
    <!-- Success Notification Toast -->
    <div id="successToastOverlay" class="success-toast-overlay"></div>
    <div id="successToast" class="success-toast">
        <div class="success-toast-icon">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <div class="success-toast-title" id="successToastTitle">Êìç‰ΩúÂÆåÊàêÔºÅ</div>
        <div class="success-toast-message" id="successToastMessage">Êï∞ÊçÆÈõÜÁîüÊàêÂ∑≤ÊàêÂäüÂÆåÊàê</div>
        <button class="success-toast-close" onclick="hideSuccessToast()">Á°ÆÂÆö</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script> // ========== Tabs Management ==========

        // Global Error Handler
        window.addEventListener('error', function (event) {
            console.error("Global Script Error:", event.error);
            // Try to notify user if showMiniToast is available
            if (typeof showMiniToast === 'function') {
                showMiniToast('error', 'Script Error', event.message || 'Unknown error');
            }
        });

        function switchTab(viewId) {
            try {
                // Update Nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const nav = document.getElementById('nav-' + viewId);
                if (nav) nav.classList.add('active');

                // Update View
                document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
                const view = document.getElementById('view-' + viewId);
                if (view) view.classList.add('active');

                if (viewId === 'monitor' && typeof chartInstance !== 'undefined' && chartInstance) {
                    setTimeout(() => chartInstance.resize(), 100);
                }

                if (viewId === 'models') {
                    if (typeof loadTrainingHistory === 'function') loadTrainingHistory();
                }

                if (viewId === 'labeling') {
                    // ËØ∑Ê±ÇÂèØÁî®Ê®°ÂûãÂàóË°®
                    window.chrome.webview.postMessage(JSON.stringify({ action: 'get_sam_models' }));

                    // Ê†áËÆ∞ÈúÄË¶ÅËá™Âä®Âä†ËΩΩÔºåÁ≠âÊ®°ÂûãÂàóË°®ËøîÂõûÂêéÂÜçÊâßË°å
                    if (typeof lblState !== 'undefined' && !lblState.samLoaded) {
                        lblState.pendingAutoLoad = true;
                    }
                }
            } catch (err) {
                console.error("switchTab error:", err);
            }
        }

        // ========== Project Management ==========
        let currentProjects = [];
        let currentProjectConfig = null;

        function loadProjects() {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_projects'
            }));
        }

        function onProjectChanged() {
            const select = document.getElementById('projectSelect');
            const idx = select.selectedIndex;

            if (idx >= 0 && currentProjects[idx]) {
                currentProjectConfig = currentProjects[idx];

                // Update Target Path (Constructed)
                const workspace = currentProjectConfig.RootPath + "\\dataset";
                document.getElementById('targetPath').value = workspace;

                // Request Subfolders
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'get_subfolders',
                    path: currentProjectConfig.RootPath
                }));
            }
        }

        function updateProjectList(projects) {
            currentProjects = projects;
            const select = document.getElementById('projectSelect');
            select.innerHTML = '';

            projects.forEach((p, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = p.Name;
                select.appendChild(opt);
            });

            if (projects.length > 0) {
                onProjectChanged();
            }

            else {
                document.getElementById('dataSourceList').innerHTML = '<div style="padding: 20px; text-align: center; color: #aab8c2;">ËØ∑ÂÖàÂàõÂª∫È°πÁõÆ (projects.json)</div>';
            }
        }

        function updateSubFolders(folders) {
            const list = document.getElementById('dataSourceList');
            list.innerHTML = '';

            if (!folders || folders.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #aab8c2;">Êú™ÊâæÂà∞Â≠êÊñá‰ª∂Â§π</div>';
                return;
            }

            folders.forEach((folder, index) => {
                const item = document.createElement('div');
                item.className = 'checklist-item stagger-item';
                item.style.animationDelay = (index * 0.05) + 's';

                item.onclick = function (e) {
                    if (e.target.type !== 'checkbox') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };

                const inp = document.createElement('input');
                inp.type = 'checkbox';
                inp.value = folder;

                const lbl = document.createElement('label');
                lbl.innerText = folder;

                item.appendChild(inp);
                item.appendChild(lbl);
                list.appendChild(item);
            });
        }

        // ========== WebView2 Bridge ==========
        window.chrome.webview.addEventListener('message', event => {
            const data = JSON.parse(event.data); // Make sure backend sends stringified JSON or object

            if (data.action === 'projects_loaded') {
                updateProjectList(data.projects);
            }

            else if (data.action === 'subfolders_loaded') {
                updateSubFolders(data.folders);
            }

            else if (data.action === 'log') {
                addLog(data.message, data.type);
            }

            else if (data.action === 'training_data') {
                // data: { epoch, box_loss, map50, map5095, progress }
                updateChart(data.epoch, data.box_loss, data.map50, data.map5095);

                // Update Progress
                if (data.progress !== undefined) {
                    const pct = Math.round(data.progress) + '%';
                    document.getElementById('progressFill').style.width = pct;
                    document.getElementById('progressPercent').innerText = pct;
                    document.getElementById('progressStatus').innerText = 'Epoch: ' + data.epoch;

                    // ETA Logic
                    updateETA(data.epoch);
                }
            }

            else if (data.action === 'folder_selected') {
                if (data.type === 'python') {
                    document.getElementById('pythonPath').value = data.path;
                    savePythonPath(data.path);
                }
                else if (data.type === 'augmentSource') document.getElementById('augmentSourcePath').value = data.path;
                else if (data.type === 'holeAssets') document.getElementById('holeAssetsPath').value = data.path;
                else if (data.type === 'newProjectRoot') document.getElementById('newProjectRoot').value = data.path;
                else if (data.type === 'toolSource') document.getElementById('toolSourcePath').value = data.path;
                else if (data.type === 'toolTarget') document.getElementById('toolTargetPath').value = data.path;
                else if (data.type === 'modelStorage') {
                    document.getElementById('modelStoragePath').value = data.path;
                    localStorage.setItem('insight_model_storage_path', data.path);
                    // If we are in model tab, refresh
                    if (document.getElementById('view-models').classList.contains('active')) {
                        refreshModels();
                    }
                }
                else if (data.type === 'labeling') {
                    // Send request to load images
                    window.chrome.webview.postMessage(JSON.stringify({
                        action: 'get_images_in_folder',
                        path: data.path
                    }));
                }
            }

            else if (data.action === 'augment_progress') {
                document.getElementById('augmentFill').style.width = data.progress + '%';
                document.getElementById('augmentStatus').innerText = 'Â§ÑÁêÜ‰∏≠ ' + data.progress + '%';
            }

            else if (data.action === 'augment_complete') {
                document.getElementById('augmentFill').style.width = '100%';
                document.getElementById('augmentStatus').innerText = 'ÂÆåÊàê 100%';

                setTimeout(() => {
                    closeAugmentModal(); addLog('Augmentation Complete', 'success');
                }

                    , 1000);
            }

            else if (data.action === 'training_finished') {
                showMiniToast('success', 'ËÆ≠ÁªÉÂÆåÊàê', 'Ê®°ÂûãËÆ≠ÁªÉÂ∑≤ÊàêÂäüÂÆåÊàêÔºÅ', 'success');
                addLog('Training Finished!', 'success');
                document.getElementById('btnStartTrain').disabled = false;
                document.getElementById('btnStopTrain').disabled = true;
                document.getElementById('btnOpenOutput').style.display = 'inline-flex';
                document.getElementById('progressStatus').innerText = 'Done';
            }

            else if (data.action === 'training_stopped') {
                showMiniToast('warning', 'ËÆ≠ÁªÉÂ∑≤ÂÅúÊ≠¢', 'Áî®Êà∑ÊâãÂä®ÂÅúÊ≠¢‰∫ÜËÆ≠ÁªÉËøõÁ®ã', 'warning');
                addLog('Training Stopped', 'warning');
                document.getElementById('btnStartTrain').disabled = false;
                document.getElementById('btnStopTrain').disabled = true;
                document.getElementById('progressStatus').innerText = 'Stopped';
            }

            else if (data.action === 'complete') {
                // ÊòæÁ§∫Âè≥‰∏äËßíÈÄöÁü•
                showMiniToast('success', 'Êìç‰ΩúÂÆåÊàê', data.message, 'success');
                addLog(data.message, 'success');
            }

            else if (data.action === 'error') {
                showMiniToast('error', 'Âá∫Èîô‰∫Ü', data.message, 'error');
                addLog(data.message, 'error');
            }

            else if (data.action === 'training_history_loaded') {
                renderTrainingHistory(data.history || []);
            }

            else if (data.action === 'python_path_saved') {
                if (data.success) {
                    showMiniToast('success', 'ËÆæÁΩÆÊàêÂäü', 'Â∑≤‰øùÂ≠ò‰∏∫ÈªòËÆ§Âú∞ÂùÄÔºåÈáçÂêØÂêéËá™Âä®ÁîüÊïà', 'success');
                } else {
                    showMiniToast('error', '‰øùÂ≠òÂ§±Ë¥•', data.error || 'Êú™Áü•ÈîôËØØ', 'error');
                }
            }

            else if (data.action === 'default_python_path_loaded') {
                if (data.path) {
                    document.getElementById('pythonPath').value = data.path;
                }
            }
        });

        // ========== Chart Logic ==========
        var chartInstance = null;
        var trainStartTime = 0;

        function initChart() {
            var ctx = document.getElementById('trainingChart').getContext('2d');
            Chart.defaults.color = '#aab8c2';
            Chart.defaults.borderColor = 'rgba(0,0,0,0.05)';

            chartInstance = new Chart(ctx, {

                type: 'line',
                data: {

                    labels: [],
                    datasets: [{
                        label: 'Box Loss', data: [], borderColor: '#d98e84', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y'
                    }

                        ,
                    {
                        label: 'mAP50', data: [], borderColor: '#8cb6a8', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y1'
                    }

                        ,
                    {
                        label: 'mAP50-95', data: [], borderColor: '#e6c587', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y1'
                    }

                    ]
                }

                ,
                options: {

                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        mode: 'index', intersect: false
                    }

                    ,
                    plugins: {
                        legend: {
                            labels: {

                                color: '#636e72',
                                font: {
                                    family: "'Microsoft YaHei UI', 'Segoe UI', sans-serif", size: 12, weight: '500'
                                }

                                ,
                                usePointStyle: true,
                                boxWidth: 8,
                                padding: 20
                            }
                        }

                        ,
                        tooltip: {

                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#2d3436',
                            bodyColor: '#636e72',
                            borderColor: '#e6e8e9',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            bodyFont: {
                                family: "'Microsoft YaHei UI', sans-serif"
                            }
                        }
                    }

                    ,
                    scales: {
                        x: {
                            ticks: {
                                color: '#b2bec3', maxTicksLimit: 10
                            }

                            , grid: {
                                display: false
                            }
                        }

                        ,
                        y: {

                            type: 'linear', display: true, position: 'left',
                            title: {
                                display: true, text: 'Loss', color: '#d98e84', font: {
                                    size: 11, weight: 'bold'
                                }
                            }

                            ,
                            ticks: {
                                color: '#d98e84'
                            }

                            ,
                            grid: {
                                borderDash: [4, 4], color: 'rgba(0,0,0,0.05)'
                            }
                        }

                        ,
                        y1: {

                            type: 'linear', display: true, position: 'right',
                            title: {
                                display: true, text: 'mAP', color: '#8cb6a8', font: {
                                    size: 11, weight: 'bold'
                                }
                            }

                            ,
                            ticks: {
                                color: '#8cb6a8',
                                // Ëá™ÂÆö‰πâÂàªÂ∫¶Ôºö0.7, 0.8, 0.85, 0.9, 0.95, 1.0
                                callback: function (value) {
                                    return value.toFixed(2);
                                },
                                stepSize: 0.05
                            }

                            ,
                            grid: {
                                display: true,
                                color: 'rgba(140, 182, 168, 0.1)'
                            }

                            ,
                            min: 0.7, max: 1.0,
                            // Âä®ÊÄÅË∞ÉÊï¥ËåÉÂõ¥ÔºàÂèØÈÄâÔºâ
                            suggestedMin: 0.7
                        }
                    }
                }
            });
        }

        setTimeout(initChart, 200);

        function updateChart(epoch, boxLoss, map50, map5095) {
            if (!chartInstance) return;

            // ÈáçÁΩÆÂõæË°®ÔºàÊñ∞ËÆ≠ÁªÉÂºÄÂßãÊó∂Ôºâ
            if (epoch === '1/...' || (typeof epoch === 'string' && epoch.startsWith('1/'))) {
                if (chartInstance.data.labels.length > 100) {
                    // Â¶ÇÊûúÊï∞ÊçÆÁÇπÂ§™Â§öÔºåÂè™‰øùÁïôÊúÄËøëÁöÑÊï∞ÊçÆ‰ª•‰ºòÂåñÊÄßËÉΩ
                    chartInstance.data.labels = [];
                    chartInstance.data.datasets.forEach(d => d.data = []);
                }
            }

            // Â§ÑÁêÜÈ™åËØÅÁªìÊûú (mAP Êï∞ÊçÆ)
            if (epoch === 'val') {
                // mAP Êï∞ÊçÆÊõ¥Êñ∞ÊúÄÂêé‰∏Ä‰∏™Êï∞ÊçÆÁÇπÁöÑÂØπÂ∫îÂÄºÔºåÊàñËÄÖËøΩÂä†Âà∞ÊúÄÊñ∞‰ΩçÁΩÆ
                var len = chartInstance.data.datasets[1].data.length;
                var labelLen = chartInstance.data.labels.length;

                if (map50 !== undefined) {
                    // Êõ¥Êñ∞ÊàñÂ°´ÂÖÖ mAP50 Êï∞ÊçÆÂà∞ÂΩìÂâç‰ΩçÁΩÆ
                    while (chartInstance.data.datasets[1].data.length < labelLen) {
                        // Áî®Ââç‰∏Ä‰∏™ÂÄºÂ°´ÂÖÖÔºåÈÅøÂÖçÊõ≤Á∫øÊñ≠Ë£Ç
                        var prevVal = chartInstance.data.datasets[1].data.length > 0
                            ? chartInstance.data.datasets[1].data[chartInstance.data.datasets[1].data.length - 1]
                            : null;
                        chartInstance.data.datasets[1].data.push(prevVal);
                    }
                    // Êõ¥Êñ∞ÊúÄÂêé‰∏Ä‰∏™ÂÄº
                    if (chartInstance.data.datasets[1].data.length > 0) {
                        chartInstance.data.datasets[1].data[chartInstance.data.datasets[1].data.length - 1] = map50;
                    } else {
                        chartInstance.data.datasets[1].data.push(map50);
                    }
                    document.getElementById('kpi-map50').innerText = map50.toFixed(3);
                }

                if (map5095 !== undefined) {
                    // Êõ¥Êñ∞ÊàñÂ°´ÂÖÖ mAP50-95 Êï∞ÊçÆÂà∞ÂΩìÂâç‰ΩçÁΩÆ
                    while (chartInstance.data.datasets[2].data.length < labelLen) {
                        var prevVal = chartInstance.data.datasets[2].data.length > 0
                            ? chartInstance.data.datasets[2].data[chartInstance.data.datasets[2].data.length - 1]
                            : null;
                        chartInstance.data.datasets[2].data.push(prevVal);
                    }
                    if (chartInstance.data.datasets[2].data.length > 0) {
                        chartInstance.data.datasets[2].data[chartInstance.data.datasets[2].data.length - 1] = map5095;
                    } else {
                        chartInstance.data.datasets[2].data.push(map5095);
                    }
                    document.getElementById('kpi-map95').innerText = map5095.toFixed(3);
                }
            } else {
                // Â§ÑÁêÜËÆ≠ÁªÉÊï∞ÊçÆ (Box Loss)
                chartInstance.data.labels.push(epoch);
                chartInstance.data.datasets[0].data.push(boxLoss);

                // ‰∏∫ mAP Êõ≤Á∫øÂ°´ÂÖÖ null Âç†‰ΩçÔºàÁ≠âÂæÖÈ™åËØÅÊï∞ÊçÆÔºâ
                // ‰ΩøÁî®Ââç‰∏Ä‰∏™ÂÄºÊù•‰øùÊåÅÊõ≤Á∫øËøûÁª≠
                var prevMap50 = chartInstance.data.datasets[1].data.length > 0
                    ? chartInstance.data.datasets[1].data[chartInstance.data.datasets[1].data.length - 1]
                    : null;
                var prevMap5095 = chartInstance.data.datasets[2].data.length > 0
                    ? chartInstance.data.datasets[2].data[chartInstance.data.datasets[2].data.length - 1]
                    : null;
                chartInstance.data.datasets[1].data.push(prevMap50);
                chartInstance.data.datasets[2].data.push(prevMap5095);

                // KPI Updates
                document.getElementById('kpi-epoch').innerText = epoch;
                if (boxLoss) document.getElementById('kpi-loss').innerText = boxLoss.toFixed(4);
            }

            // ÊÄßËÉΩ‰ºòÂåñÔºöÈôêÂà∂Êï∞ÊçÆÁÇπÊï∞ÈáèÔºåË∂ÖËøá500ÁÇπÊó∂ÊäΩÊ†∑ÊòæÁ§∫
            if (chartInstance.data.labels.length > 500) {
                // ÊØèÈöî5‰∏™ÁÇπ‰øùÁïô‰∏Ä‰∏™
                var step = 5;
                chartInstance.data.labels = chartInstance.data.labels.filter((_, i) => i % step === 0 || i === chartInstance.data.labels.length - 1);
                chartInstance.data.datasets.forEach(d => {
                    d.data = d.data.filter((_, i) => i % step === 0 || i === d.data.length - 1);
                });
            }

            // ËäÇÊµÅÊõ¥Êñ∞ÔºöÊØè10Ê¨°Ë∞ÉÁî®Âè™Êõ¥Êñ∞‰∏ÄÊ¨°ÂõæË°®ÔºåÂáèÂ∞ëÊÄßËÉΩÂºÄÈîÄ
            if (!window._chartUpdateCounter) window._chartUpdateCounter = 0;
            window._chartUpdateCounter++;
            if (window._chartUpdateCounter % 5 === 0 || epoch === 'val') {
                chartInstance.update('none'); // 'none' Ê®°ÂºèÁ¶ÅÁî®Âä®ÁîªÔºåÊèêÈ´òÊÄßËÉΩ
            }
        }

        function updateETA(epochStr) {
            if (trainStartTime === 0) trainStartTime = Date.now();

            if (typeof epochStr === 'string' && epochStr.includes('/')) {
                const parts = epochStr.split('/');
                const current = parseInt(parts[0]);
                const total = parseInt(parts[1]);

                if (current > 0 && total > 0) {
                    const elapsed = (Date.now() - trainStartTime) / 1000;
                    const avg = elapsed / current;
                    const remaining = (total - current) * avg;

                    const m = Math.floor(remaining / 60);
                    const s = Math.floor(remaining % 60);

                    document.getElementById('progressETA').innerText = `ETA: ${m}m ${s}s`;
                }
            }
        }

        function addLog(msg, type = 'info') {

            // Update Status Message on Config Tab
            if (msg.includes('ÁîüÊàêÊï∞ÊçÆÈõÜ') || msg.includes('Processing')) {
                document.getElementById('statusMessage').innerText = msg;
                document.getElementById('statusMessage').style.color = '#7f8fa4';
            }

            if (msg.includes('ÂÆåÊàê') || msg.includes('Success')) {
                document.getElementById('statusMessage').innerText = msg;
                document.getElementById('statusMessage').style.color = '#00b894';
            }

            if (type === 'error') {
                document.getElementById('statusMessage').innerText = msg;
                document.getElementById('statusMessage').style.color = '#d63031';
            }

            // Sync to Main Console
            const consoleDiv = document.getElementById('console');
            const item = document.createElement('div');
            item.className = 'log-item';
            const time = new Date().toLocaleTimeString();
            let colorClass = 'log-info';
            if (type === 'error') colorClass = 'log-error';
            if (type === 'success') colorClass = 'log-success';
            if (type === 'warning') colorClass = 'log-warning';

            item.innerHTML = `<span class="log-time">[${time}]</span><span class="${colorClass}">${msg}</span>`;
            consoleDiv.appendChild(item);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;

            // Sync to Mini Console (Config Tab)
            const miniConsole = document.getElementById('configConsole');
            if (miniConsole) {
                const miniItem = document.createElement('div');
                miniItem.style.marginBottom = '2px';
                miniItem.style.color = (type === 'error') ? '#ff5252' : ((type === 'success') ? '#0be881' : '#dcdde1');
                miniItem.innerText = `>${msg}`;
                miniConsole.appendChild(miniItem);
                miniConsole.scrollTop = miniConsole.scrollHeight;
            }

            // Sync to Tool Console
            const toolConsole = document.getElementById('toolConsole');
            if (toolConsole) {
                const item = document.createElement('div');
                item.className = 'log-item';
                const time = new Date().toLocaleTimeString();

                let colorClass = 'log-info';
                if (type === 'error') colorClass = 'log-error';
                if (type === 'success') colorClass = 'log-success';

                item.innerHTML = `<span class="log-time">[${time}]</span><span class="${colorClass}">${msg}</span>`;
                toolConsole.appendChild(item);
                toolConsole.scrollTop = toolConsole.scrollHeight;
            }
        }

        // ========== Success Toast Notification ==========
        function showSuccessToast(message, title = 'Êìç‰ΩúÂÆåÊàêÔºÅ') {
            document.getElementById('successToastTitle').innerText = title;
            document.getElementById('successToastMessage').innerText = message;
            document.getElementById('successToastOverlay').classList.add('show');
            document.getElementById('successToast').classList.add('show');

            // Êí≠ÊîæÊèêÁ§∫Èü≥ (ÂèØÈÄâ)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAB/f39/');
                audio.volume = 0.3;
                audio.play().catch(() => { });
            } catch (e) { }
        }

        function hideSuccessToast() {
            document.getElementById('successToastOverlay').classList.remove('show');
            document.getElementById('successToast').classList.remove('show');
        }

        // ========== Actions ==========
        function selectFile(type) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'select_file', type: type
            }));
        }

        function selectFolder(type) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'select_folder', type: type
            }));
        }

        function startGenerate() {
            if (!currentProjectConfig) {
                showMiniToast('warning', 'ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©È°πÁõÆ', 'warning');
                return;
            }

            // Collect checked folders
            const checkboxes = document.querySelectorAll('#dataSourceList input[type="checkbox"]:checked');

            if (checkboxes.length === 0) {
                showMiniToast('warning', 'ÊèêÁ§∫', 'ËØ∑Ëá≥Â∞ëÂãæÈÄâ‰∏Ä‰∏™Êï∞ÊçÆÊ∫êÊñá‰ª∂Â§π', 'warning');
                return;
            }

            const sourcePaths = Array.from(checkboxes).map(cb => {
                return currentProjectConfig.RootPath + "\\" + cb.value;
            });

            const conf = {
                action: 'generate',
                sourcePaths: sourcePaths,
                targetPath: document.getElementById('targetPath').value,
                classes: currentProjectConfig.Classes,

                modelSize: document.getElementById('modelSize').value,
                imgSize: parseInt(document.getElementById('imgSize').value),
                epochs: parseInt(document.getElementById('epochs').value),
                batchSize: parseInt(document.getElementById('batchSize').value),
                patience: parseInt(document.getElementById('patience').value),
                workers: parseInt(document.getElementById('workers').value),
                gpuIndex: document.getElementById('gpuIndex').value,
                enableP2: document.getElementById('enableP2').checked,
                autoFixImage: document.getElementById('autoFixImage').checked
            };

            window.chrome.webview.postMessage(JSON.stringify(conf));
        }

        function startTraining() {
            switchTab('monitor');
            addLog("Ê≠£Âú®ÂèëÈÄÅËÆ≠ÁªÉËØ∑Ê±Ç...", "info");
            trainStartTime = 0;
            document.getElementById('progressETA').innerText = '';

            const workDir = document.getElementById('targetPath').value;

            document.getElementById('btnStartTrain').disabled = true;
            document.getElementById('btnStopTrain').disabled = false;

            // New Params
            const customOnnxName = document.getElementById('customOnnxName').value;
            const modelStoragePath = document.getElementById('modelStoragePath').value || "";

            // Save storage path if set
            if (modelStoragePath) {
                localStorage.setItem('insight_model_storage_path', modelStoragePath);
            }

            const conf = {
                action: 'start_training',
                pythonPath: document.getElementById('pythonPath').value,
                workDir: workDir,
                // Add missing params from UI that were not in original startTraining but might be needed
                // actually original startTraining only sent pythonPath and workDir, 
                // but HandleStartTraining in backend reads everything from 'data'.
                // The previous HandleGenerate used a different set. 
                // Let's ensure startTraining sends ALL params needed by backend HandleStartTraining.
                // Re-reading HandleStartTraining in Insight.cs (lines 895+) would show what it needs.
                // Assuming backend reads from the same 'data' object.

                // Oops, looking at Insight.cs HandleStartTraining (viewed previously), it seemingly re-reads params?
                // No, HandleStartTraining (step 292 view) wasn't fully shown. 
                // But HandleGenerate (lines 392) reads params.
                // Let's assume HandleStartTraining in backend reads these too.
                // The user's original startTraining (line 1665) ONLY sent pythonPath and workDir.
                // This implies HandleStartTraining might have been reading from a 'config' or maybe the user ISN'T sending params?
                // Wait, if I scroll up to 1665 in existing file, it only sends pythonPath and workDir.
                // This is weird. Let me assume I need to send everything.
                modelSize: document.getElementById('modelSize').value,
                imgSize: parseInt(document.getElementById('imgSize').value) || 640,
                epochs: parseInt(document.getElementById('epochs').value) || 300,
                batchSize: parseInt(document.getElementById('batchSize').value) || 16,
                patience: parseInt(document.getElementById('patience').value) || 50,
                workers: parseInt(document.getElementById('workers').value) || 8,
                gpuIndex: document.getElementById('gpuIndex').value || "0",
                enableP2: document.getElementById('enableP2').checked,
                autoFixImage: document.getElementById('autoFixImage').checked,
                onnxName: customOnnxName,
                modelStoragePath: modelStoragePath,
                classes: (currentProjectConfig && currentProjectConfig.Classes) ? currentProjectConfig.Classes : []
            };

            console.log("Sending training config:", conf);
            window.chrome.webview.postMessage(JSON.stringify(conf));
        }

        function stopTraining() {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'stop_training'
            }));
        }

        // --- Model Management Logic ---

        function getModelStoragePath() {
            // Priority 1: User-specified custom path
            let path = document.getElementById('modelStoragePath').value;

            // Priority 2: Saved in localStorage
            if (!path) {
                path = localStorage.getItem('insight_model_storage_path');
            }

            // Priority 3: Current project's dataset folder (where training outputs go)
            if (!path && currentProjectConfig && currentProjectConfig.RootPath) {
                path = currentProjectConfig.RootPath + "\\dataset";
            }

            // Priority 4: targetPath input (only works when on Config tab)
            if (!path) {
                path = document.getElementById('targetPath').value;
            }

            console.log("[getModelStoragePath] Resolved path:", path);
            return path;
        }

        // === Simplified Training History ===

        function loadTrainingHistory() {
            console.log("[loadTrainingHistory] Requesting training history...");
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_training_history'
            }));
        }

        function renderTrainingHistory(entries) {
            const tbody = document.getElementById('trainingHistoryBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!entries || entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #aaa; padding: 30px;">ÊöÇÊó†ËÆ≠ÁªÉËÆ∞ÂΩï„ÄÇÂÆåÊàê‰∏ÄÊ¨°ËÆ≠ÁªÉÂêéËøôÈáå‰ºöÊòæÁ§∫ÂéÜÂè≤„ÄÇ</td></tr>';
                return;
            }

            // Sort by date descending (newest first)
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            entries.forEach((entry, index) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';
                tr.className = 'stagger-item';
                tr.style.animationDelay = (index * 0.05) + 's';

                // Project Name
                const projectName = entry.projectName || 'Unknown';

                // Config: modelSize, imgSize, epochs, batchSize
                const configStr = `${entry.modelSize || '-'} | ${entry.imgSize || 640}px | ${entry.epochs || '-'}e | B${entry.batchSize || '-'}`;

                // Training Metrics: Loss / mAP50 / mAP50-95
                const loss = entry.finalLoss !== undefined ? entry.finalLoss.toFixed(3) : '-';
                const map50 = entry.mAP50 !== undefined ? (entry.mAP50 * 100).toFixed(1) + '%' : '-';
                const map5095 = entry.mAP5095 !== undefined ? (entry.mAP5095 * 100).toFixed(1) + '%' : '-';
                const metricsStr = `
                    <span style="background:rgba(255,100,100,0.2); color:#ff6b6b; padding:2px 6px; border-radius:4px; margin-right:4px; font-size:11px;">Loss: ${loss}</span>
                    <span style="background:rgba(0,212,255,0.2); color:#0be881; padding:2px 6px; border-radius:4px; margin-right:4px; font-size:11px;">mAP50: ${map50}</span>
                    <span style="background:rgba(100,200,255,0.2); color:#74b9ff; padding:2px 6px; border-radius:4px; font-size:11px;">mAP50-95: ${map5095}</span>
                `;

                // Date
                const dateStr = entry.date || '-';

                // Build row HTML (without button)
                tr.innerHTML = `
                    <td style="padding: 12px; font-weight: 500;">${projectName}</td>
                    <td style="padding: 12px; font-size: 12px; color: #aaa;">${configStr}</td>
                    <td style="padding: 12px;">${metricsStr}</td>
                    <td style="padding: 12px; font-size: 12px; color: #aaa;">${dateStr}</td>
                    <td style="padding: 12px; text-align: center;" class="action-cell"></td>
                `;

                // Create button programmatically to avoid escaping issues
                const modelPath = entry.modelPath || '';
                const actionCell = tr.querySelector('.action-cell');

                if (modelPath && actionCell) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-secondary btn-icon';
                    btn.title = 'ÊâìÂºÄÊ®°ÂûãÊâÄÂú®Êñá‰ª∂Â§π';
                    btn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;

                    btn.onclick = function (e) {
                        // Use proper path from closure
                        window.chrome.webview.postMessage(JSON.stringify({
                            action: 'open_model_folder',
                            path: modelPath
                        }));
                    };
                    actionCell.appendChild(btn);
                } else {
                    if (actionCell) actionCell.textContent = '-';
                }

                tbody.appendChild(tr);
            });
        }

        function openModelFolder(modelPath) {
            console.log("[openModelFolder] Called with:", modelPath);
            addLog("Ê≠£Âú®ÊâìÂºÄÊñá‰ª∂Â§π: " + modelPath, "info");
            if (!modelPath) {
                addLog("Ë∑ØÂæÑ‰∏∫Á©∫ÔºåÊó†Ê≥ïÊâìÂºÄ", "warning");
                return;
            }
            try {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'open_model_folder',
                    path: modelPath
                }));
                console.log("[openModelFolder] Message sent to backend");
            } catch (err) {
                console.error("[openModelFolder] Error:", err);
                addLog("ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•: " + err.message, "error");
            }
        }


        function refreshModels() {
            const path = getModelStoragePath();
            console.log("[refreshModels] Final path:", path);

            if (!path) {
                console.warn("[refreshModels] No path available, cannot load models");
                addLog("Êó†Ê≥ïÂä†ËΩΩÊ®°ÂûãÂàóË°®: ËØ∑ÂÖàÈÄâÊã©È°πÁõÆÊàñËÆæÁΩÆÊ®°ÂûãÂ≠òÂÇ®Ë∑ØÂæÑ", "warning");
                return;
            }

            // Sync UI
            document.getElementById('currentModelPath').value = path;
            document.getElementById('modelStoragePath').value = path;

            console.log("[refreshModels] Sending get_models request for:", path);
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_models',
                path: path
            }));
        }

        function filterModels() {
            const query = document.getElementById('modelSearch').value.toLowerCase();
            const filtered = currentModelList.filter(m => m.name.toLowerCase().includes(query));
            renderModelList(filtered);
        }

        function renderModelList(models) {
            const tbody = document.getElementById('modelTableBody');
            tbody.innerHTML = '';

            if (!models || models.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #aaa; padding: 20px;">No models found. Train one to see history!</td></tr>';
                return;
            }

            models.forEach(model => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';

                // --- Metadata Parsing ---
                let configStr = '<span style="color:#aaa;">-</span>';

                if (model.metadata && model.metadata.paramsData) {
                    const p = model.metadata.paramsData;
                    configStr = `<span style="background:var(--bg-card); border:1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; color:var(--text-main); font-family:Consolas; font-size: 11px;">${p.ModelSize}</span> 
                                     <span style="color:var(--text-sub); font-size:11px; margin-left: 4px;">${p.ImgSize}px</span>`;
                }

                // Name Column (Icon + Name)
                const typeBadge = `<div style="display:flex; align-items:center; gap:8px;">
                                    <div style="width: 32px; height: 32px; background: rgba(0, 137, 123, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00897B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                    </div>
                                    <div>
                                        <div style="font-weight:bold; font-size:13px; color: var(--text-main);">${model.name}</div>
                                        <div style="font-size:11px; color: var(--text-light);">${model.size}</div>
                                    </div>
                                  </div>`;

                // Actions
                const actions = `
                        <button class="btn btn-secondary btn-icon" title="ÈáçÂëΩÂêç" onclick="renameModel('${model.name}')" style="padding:6px; width: 32px; height: 32px;">
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="btn btn-danger btn-icon" title="Âà†Èô§" onclick="deleteModel('${model.name}')" style="padding:6px; width: 32px; height: 32px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                        <button class="btn btn-secondary btn-icon" title="ËΩ¨Êç¢" onclick="convertModel('${model.name}')" style="padding:6px; width: 32px; height: 32px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        </button>
                    `;

                tr.innerHTML = `
                    <td style="padding: 12px;">${typeBadge}</td>
                    <td style="padding: 12px; font-size: 13px;">${configStr}</td>
                    <td style="padding: 12px; font-size: 12px; color: var(--text-sub);">${model.date}</td>
                    <td style="padding: 12px; text-align: right; display:flex; gap:6px; justify-content:flex-end;">${actions}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openModelFolder() {
            const path = getModelStoragePath();
            if (path) {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'open_output',
                    path: path
                }));
            }
        }

        function renameModel(oldName) {
            const newName = prompt("ËØ∑ËæìÂÖ•Êñ∞ÂêçÁß∞ (Êó†ÈúÄÂêéÁºÄ):", oldName.replace(/\.(onnx|pt)$/i, ""));
            if (newName && newName !== oldName.replace(/\.(onnx|pt)$/i, "")) {
                const ext = oldName.split('.').pop();
                const fullName = newName.endsWith('.' + ext) ? newName : newName + '.' + ext;

                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'rename_model',
                    path: getModelStoragePath(),
                    oldName: oldName,
                    newName: fullName
                }));
            }
        }

        function deleteModel(fileName) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Âûã ${fileName} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'delete_model',
                    path: getModelStoragePath(),
                    fileName: fileName
                }));
            }
        }

        function convertModel(fileName) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'convert_model',
                sourcePath: getModelStoragePath() + "\\" + fileName,
                targetDir: getModelStoragePath(),
                pythonPath: document.getElementById('pythonPath').value
            }));
        }

        function openOutputFolder() {
            const p = document.getElementById('targetPath').value;

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'open_output', path: p
            }));
        }

        // Create Project Modal
        function openCreateProjectModal() {
            document.getElementById('createProjectModal').style.display = 'flex';
        }

        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').style.display = 'none';
        }

        function createProject() {
            const name = document.getElementById('newProjectName').value;
            const root = document.getElementById('newProjectRoot').value;
            const classes = document.getElementById('newProjectClasses').value;

            if (!name || !root) {
                showMiniToast('warning', 'ÊèêÁ§∫', 'È°πÁõÆÂêçÁß∞ÂíåÊ†πÁõÆÂΩï‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'create_project',
                name: name,
                rootPath: root,
                classes: classes
            }));

            closeCreateProjectModal();
        }

        function deleteProject() {
            if (!currentProjectConfig) return;
            const idx = document.getElementById('projectSelect').selectedIndex;
            if (idx < 0) return;

            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩìÂâçÈ°πÁõÆÂêóÔºüÊ≠§Êìç‰Ωú‰ªÖÁßªÈô§ÂàóË°®È°πÔºå‰∏ç‰ºöÂà†Èô§Á°¨ÁõòÊñá‰ª∂„ÄÇ')) {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'delete_project',
                    index: idx
                }));
            }
        }

        // Defect Modal
        function openAugmentModal() {
            document.getElementById('augmentModal').style.display = 'flex';
        }

        function closeAugmentModal() {
            document.getElementById('augmentModal').style.display = 'none';
        }

        function startAugmentation() {
            const conf = {
                action: 'defect_augmentation',
                sourcePath: document.getElementById('augmentSourcePath').value,
                holeAssetsPath: document.getElementById('holeAssetsPath').value,
                mutationRate: parseInt(document.getElementById('mutationRate').value)
            };

            window.chrome.webview.postMessage(JSON.stringify(conf));
        }

        // Helper
        function selectFolder(type) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'select_folder',
                type: type
            }));
        }

        function startToolConversion() {
            const src = document.getElementById('toolSourcePath').value;
            const tgt = document.getElementById('toolTargetPath').value;

            if (!src || !tgt) {
                showMiniToast('warning', 'ÊèêÁ§∫', 'ËØ∑ÂÖàÈÄâÊã©Ê∫êÊñá‰ª∂Â§πÂíåÁõÆÊ†áË∑ØÂæÑ');
                return;
            }

            // Clear log
            document.getElementById('toolConsole').innerHTML = '<div class="log-item"><span class="log-time">[System]</span>Starting conversion...</div>';

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'convert_tool',
                sourcePath: src,
                targetPath: tgt
            }));
        }

        // ========== Python Path Persistence ==========
        const DEFAULT_PYTHON_PATH = 'C:\\conda_envs\\yolo\\python.exe';

        function loadPythonPath() {
            // ËØ∑Ê±ÇÂêéÁ´ØÂä†ËΩΩÈªòËÆ§Ë∑ØÂæÑ
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_default_python_path'
            }));
        }

        function savePythonPath(path) {
            // ‰∏¥Êó∂‰øùÂ≠òÔºàÂèØÈÄâÔºåÁõÆÂâç‰∏çÂÅöÊåÅ‰πÖÂåñÔºâ
        }

        function saveAsDefaultPythonPath() {
            var currentPath = document.getElementById('pythonPath').value;
            if (!currentPath || currentPath.trim() === '') {
                showMiniToast('warning', 'ËÆæÁΩÆÂ§±Ë¥•', 'ËØ∑ÂÖàËæìÂÖ•ÊúâÊïàÁöÑ Python ÁéØÂ¢ÉË∑ØÂæÑ');
                return;
            }
            // ÈÄöËøáÂêéÁ´Ø‰øùÂ≠ò‰∏∫ÈªòËÆ§Âú∞ÂùÄ
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'save_default_python_path',
                path: currentPath
            }));
        }

        function showMiniToast(type, title, message) {
            // Remove old toast
            var oldToast = document.querySelector('.mini-toast');
            if (oldToast) oldToast.remove();

            // Determine Icon & Color
            var iconSvg = '';
            var bg = '';

            if (type === 'success') {
                iconSvg = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                bg = 'linear-gradient(135deg, #00897B, #26A69A)';
            } else if (type === 'warning') {
                iconSvg = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                bg = 'linear-gradient(135deg, #FF9800, #F57C00)';
            } else if (type === 'error') {
                iconSvg = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
                bg = 'linear-gradient(135deg, #E53935, #C62828)';
            } else {
                // Info / Default
                iconSvg = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
                bg = 'linear-gradient(135deg, #455A64, #607D8B)';
            }

            // Create new toast
            var toast = document.createElement('div');
            toast.className = 'mini-toast';
            toast.style.background = bg;

            toast.innerHTML = '<div class="mini-toast-icon">' + iconSvg + '</div>' +
                '<div class="mini-toast-content">' +
                '<div class="mini-toast-title">' + title + '</div>' +
                '<div class="mini-toast-message">' + message + '</div>' +
                '</div>';

            document.body.appendChild(toast);

            // Animation
            setTimeout(function () { toast.classList.add('show'); }, 50);

            // Auto Dismiss
            setTimeout(function () {
                toast.classList.remove('show');
                setTimeout(function () { toast.remove(); }, 400);
            }, 3000);
        }


        // ========== Labeling Logic (SAM2) ==========
        const lblState = {
            images: [],
            currentIndex: -1,
            image: null,      // Image Object
            imgW: 0,
            imgH: 0,

            // Viewport
            scale: 1,
            offset: { x: 0, y: 0 },
            isDragging: false,
            lastMouse: { x: 0, y: 0 },

            // Annotation
            mode: 'auto',     // 'auto' | 'rect'
            prompts: [],      // {x, y, isPositive} (Image Space)
            tempBox: null,    // {x, y, w, h} (Image Space) - From SAM
            manualStart: null,// {x, y} (Image Space) - For manual rect

            // Data
            annotations: [],  // {labelIndex, bbox: [x,y,w,h]}
            labels: [],       // Strings
            activeLabelIndex: 0,

            samLoaded: false
        };

        const canvas = document.getElementById('labelingCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWrapper = document.getElementById('canvasWrapper');

        // --- Layout & Resize ---
        function resizeCanvas() {
            if (!canvasWrapper) return;
            canvas.width = canvasWrapper.clientWidth;
            canvas.height = canvasWrapper.clientHeight;
            renderCanvas();
        }
        new ResizeObserver(resizeCanvas).observe(canvasWrapper);

        // --- Core Interaction ---
        canvas.addEventListener('mousedown', e => {
            if (e.button === 1 || (e.button === 0 && e.ctrlKey)) {
                // Pan
                lblState.isDragging = true;
                lblState.lastMouse = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
                return;
            }

            if (!lblState.image) return;

            const rect = canvas.getBoundingClientRect();
            // Mouse to Image Coords
            const mx = (e.clientX - rect.left - lblState.offset.x) / lblState.scale;
            const my = (e.clientY - rect.top - lblState.offset.y) / lblState.scale;

            if (mx < 0 || my < 0 || mx > lblState.imgW || my > lblState.imgH) return;

            if (lblState.mode === 'auto') {
                // ËÆ∞ÂΩïËµ∑ÂßãÁÇπÔºåÂú® mouseup Êó∂ÂÜ≥ÂÆöÊòØÁÇπÂáªËøòÊòØÊãñÊãΩ
                lblState.autoStart = { x: mx, y: my, button: e.button };
                lblState.tempBox = null; // Ê∏ÖÁ©∫‰∏¥Êó∂Ê°Ü
            } else if (lblState.mode === 'rect') {
                if (e.button === 0) {
                    lblState.manualStart = { x: mx, y: my };
                    lblState.tempBox = { x: mx, y: my, w: 0, h: 0 }; // Init temp box
                }
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (lblState.isDragging) {
                const dx = e.clientX - lblState.lastMouse.x;
                const dy = e.clientY - lblState.lastMouse.y;
                lblState.offset.x += dx;
                lblState.offset.y += dy;
                lblState.lastMouse = { x: e.clientX, y: e.clientY };
                renderCanvas();
                return;
            }

            // Update Rect Drag for rect mode
            if (lblState.mode === 'rect' && lblState.manualStart) {
                const rect = canvas.getBoundingClientRect();
                const mx = (e.clientX - rect.left - lblState.offset.x) / lblState.scale;
                const my = (e.clientY - rect.top - lblState.offset.y) / lblState.scale;

                const w = mx - lblState.manualStart.x;
                const h = my - lblState.manualStart.y;

                // Normalization handled at render/save
                lblState.tempBox = {
                    x: w > 0 ? lblState.manualStart.x : mx,
                    y: h > 0 ? lblState.manualStart.y : my,
                    w: Math.abs(w),
                    h: Math.abs(h)
                };
                renderCanvas();
            }

            // Ëá™Âä®Ê®°ÂºèÁöÑÊãñÊãΩÈ¢ÑËßà
            if (lblState.mode === 'auto' && lblState.autoStart) {
                const rect = canvas.getBoundingClientRect();
                const mx = (e.clientX - rect.left - lblState.offset.x) / lblState.scale;
                const my = (e.clientY - rect.top - lblState.offset.y) / lblState.scale;

                const dx = mx - lblState.autoStart.x;
                const dy = my - lblState.autoStart.y;

                // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøá 5pxÔºåÊòæÁ§∫‰∏¥Êó∂Ê°Ü
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    lblState.tempBox = {
                        x: dx > 0 ? lblState.autoStart.x : mx,
                        y: dy > 0 ? lblState.autoStart.y : my,
                        w: Math.abs(dx),
                        h: Math.abs(dy)
                    };
                    renderCanvas();
                }
            }
        });

        canvas.addEventListener('mouseup', e => {
            if (lblState.isDragging) {
                lblState.isDragging = false;
                canvas.style.cursor = 'default';
                return;
            }
            if (lblState.mode === 'rect' && lblState.manualStart) {
                // Finish Rect
                if (lblState.tempBox && lblState.tempBox.w > 5 && lblState.tempBox.h > 5) {
                    // Auto commit manual rect
                    commitAnnotation();
                } else {
                    lblState.tempBox = null;
                }
                lblState.manualStart = null;
                renderCanvas();
            }

            // Ëá™Âä®Ê®°ÂºèÔºöÂà§Êñ≠ÊòØÁÇπÂáªËøòÊòØÊãñÊãΩ
            if (lblState.mode === 'auto' && lblState.autoStart) {
                const rect = canvas.getBoundingClientRect();
                const mx = (e.clientX - rect.left - lblState.offset.x) / lblState.scale;
                const my = (e.clientY - rect.top - lblState.offset.y) / lblState.scale;

                const dx = mx - lblState.autoStart.x;
                const dy = my - lblState.autoStart.y;

                if (Math.abs(dx) < 5 && Math.abs(dy) < 5) {
                    // ÁÇπÂáªÊ®°ÂºèÔºöÊ∑ªÂä†ÁÇπÊèêÁ§∫
                    const isPositive = lblState.autoStart.button === 0;
                    lblState.prompts.push({ x: lblState.autoStart.x, y: lblState.autoStart.y, isPositive });
                    requestSAMInference();
                } else {
                    // ÊãñÊãΩÊ®°ÂºèÔºöÊ∏ÖÁ©∫‰πãÂâçÁöÑÁÇπÊèêÁ§∫ÔºåÂèëÈÄÅÊ°ÜÊèêÁ§∫
                    lblState.prompts = [];
                    requestSAMInferenceWithBox(lblState.tempBox);
                }

                lblState.autoStart = null;
                renderCanvas();
            }
        });

        // Prevent Context Menu on Canvas (for Right Click usage)
        canvas.addEventListener('contextmenu', e => e.preventDefault());

        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const zoomSpeed = 0.1;
            const delta = -Math.sign(e.deltaY) * zoomSpeed;
            const newScale = Math.max(0.1, Math.min(10, lblState.scale * (1 + delta)));

            // Zoom towards mouse
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            const imgX = (mx - lblState.offset.x) / lblState.scale;
            const imgY = (my - lblState.offset.y) / lblState.scale;

            lblState.offset.x = mx - imgX * newScale;
            lblState.offset.y = my - imgY * newScale;
            lblState.scale = newScale;

            renderCanvas();
            updateCanvasInfo();
        });

        // --- Rendering ---
        function renderCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(lblState.offset.x, lblState.offset.y);
            ctx.scale(lblState.scale, lblState.scale);

            // 1. Image
            if (lblState.image) {
                ctx.drawImage(lblState.image, 0, 0);
            }

            // 2. Existing Annotations
            ctx.lineWidth = 2 / lblState.scale;
            lblState.annotations.forEach(ann => {
                ctx.strokeStyle = '#00E676'; // Customize color per label later
                ctx.fillStyle = 'rgba(0, 230, 118, 0.2)';
                const b = ann.bbox;
                ctx.beginPath();
                ctx.rect(b.x, b.y, b.w, b.h);
                ctx.stroke();
                ctx.fill();

                // Label Text
                ctx.fillStyle = '#00E676';
                ctx.font = `${14 / lblState.scale}px Arial`;
                const labelName = lblState.labels[ann.labelIndex] || ann.labelIndex;
                ctx.fillText(labelName, b.x, b.y - 5 / lblState.scale);
            });

            // 3. Current Temp Box (Active)
            if (lblState.tempBox) {
                ctx.strokeStyle = '#2979FF';
                ctx.lineWidth = 2 / lblState.scale;
                ctx.setLineDash([5 / lblState.scale, 5 / lblState.scale]);
                const b = lblState.tempBox;
                ctx.strokeRect(b.x, b.y, b.w, b.h);
                ctx.setLineDash([]);
            }

            // 4. Prompts
            lblState.prompts.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5 / lblState.scale, 0, Math.PI * 2);
                ctx.fillStyle = p.isPositive ? '#00E676' : '#FF1744';
                ctx.strokeStyle = '#FFF';
                ctx.lineWidth = 2 / lblState.scale;
                ctx.fill();
                ctx.stroke();
            });

            ctx.restore();
            updateCanvasInfo();
        }

        function updateCanvasInfo() {
            const info = document.getElementById('canvasInfo');
            if (lblState.image) {
                const z = Math.round(lblState.scale * 100);
                info.innerText = `${lblState.imgW}x${lblState.imgH} | ${z}%`;
            } else {
                info.innerText = "No Image";
            }
        }

        // --- Actions ---

        function setLabelingMode(m) {
            lblState.mode = m;
            document.getElementById('tool-auto').classList.toggle('active', m === 'auto');
            document.getElementById('tool-rect').classList.toggle('active', m === 'rect');
        }

        function labelingAction(act) {
            if (act === 'undo') {
                if (lblState.mode === 'auto' && lblState.prompts.length > 0) {
                    lblState.prompts.pop();
                    requestSAMInference();
                } else if (lblState.mode === 'rect') {
                    // Undo rect? maybe just clear
                    lblState.tempBox = null;
                }
            } else if (act === 'clear') {
                lblState.prompts = [];
                lblState.tempBox = null;
                lblState.manualStart = null;
            } else if (act === 'complete') {
                commitAnnotation();
            }
            renderCanvas();
        }

        function commitAnnotation() {
            if (!lblState.tempBox) return;
            // Check if label exists
            if (lblState.labels.length === 0) {
                showMiniToast('warning', 'Êó†Ê†áÁ≠æ', 'ËØ∑ÂÖàÊ∑ªÂä†Ëá≥Â∞ë‰∏Ä‰∏™Ê†áÁ≠æÁ±ªÂà´');
                return;
            }

            lblState.annotations.push({
                labelIndex: lblState.activeLabelIndex,
                bbox: { ...lblState.tempBox }
            });

            // Clear current state
            lblState.prompts = [];
            lblState.tempBox = null;
            renderCanvas();
            renderAnnotationList();

            // Auto Save to Backend
            saveAnnotations();
        }

        // --- Shortcuts ---
        window.addEventListener('keydown', e => {
            if (!document.getElementById('view-labeling').classList.contains('active')) return;
            if (e.target.tagName === 'INPUT') return; // Ignore input fields

            switch (e.key.toLowerCase()) {
                case 'a': prevImage(); break;
                case 'd': nextImage(); break;
                case 'q': setLabelingMode('auto'); break;
                case 'r': setLabelingMode('rect'); break;
                case 'f': labelingAction('complete'); break;
                case 'enter': labelingAction('complete'); break;
                case 'b': labelingAction('clear'); break;
                case 'escape': labelingAction('clear'); break;
                case 'z': if (e.ctrlKey) labelingAction('undo'); break;
            }
        });

        // --- Backend Communication ---
        function openLabelingFolder() {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'select_folder',
                type: 'labeling'
            }));
        }

        function loadSAMModel() {
            const btn = document.getElementById('btnLoadModel');
            const modelName = document.getElementById('samModelSelect').value;

            if (!modelName) {
                showMiniToast('error', 'Êú™ÈÄâÊã©Ê®°Âûã', 'ËØ∑ÂÖàÂú®‰∏ãÊãâÂàóË°®‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ê®°Âûã');
                return;
            }

            btn.disabled = true;
            btn.innerText = "‚è≥ Âä†ËΩΩ‰∏≠...";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'load_sam_model',
                modelName: modelName,
                useGpu: document.getElementById('samUseGpu').checked
            }));
        }

        function requestSAMInference() {
            if (lblState.prompts.length === 0) {
                lblState.tempBox = null;
                renderCanvas();
                return;
            }
            if (!lblState.samLoaded) return; // Silent return if model not ready

            const threshold = parseFloat(document.getElementById('samThreshold').value) || 0;
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'sam_inference',
                prompts: lblState.prompts,
                threshold: threshold,
                origW: lblState.imgW,
                origH: lblState.imgH
            }));
        }

        function requestSAMInferenceWithBox(box) {
            if (!box || box.w < 5 || box.h < 5) {
                lblState.tempBox = null;
                renderCanvas();
                return;
            }
            if (!lblState.samLoaded) {
                showMiniToast('warning', 'Ê®°ÂûãÊú™Âä†ËΩΩ', 'ËØ∑ÂÖàÂä†ËΩΩ SAM Ê®°Âûã');
                return;
            }

            const threshold = parseFloat(document.getElementById('samThreshold').value) || 0;
            // ÂèëÈÄÅÂ∏¶ boxPrompt ÁöÑÊé®ÁêÜËØ∑Ê±Ç
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'sam_inference',
                boxPrompt: {
                    x1: box.x,
                    y1: box.y,
                    x2: box.x + box.w,
                    y2: box.y + box.h
                },
                threshold: threshold,
                origW: lblState.imgW,
                origH: lblState.imgH
            }));
        }

        function loadImage(index) {
            if (index < 0 || index >= lblState.images.length) return;

            // Save current before switching?
            // saveAnnotations(); // Auto-saved on commit, but maybe final check?

            const item = lblState.images[index];
            lblState.currentIndex = index;
            document.getElementById('currentImageName').innerText = item.name;

            // Update List UI
            document.querySelectorAll('.image-list-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });

            // Request Image Data (Base64)
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_image_data',
                path: item.path
            }));
        }

        function nextImage() { loadImage(lblState.currentIndex + 1); }
        function prevImage() { loadImage(lblState.currentIndex - 1); }

        function saveAnnotations() {
            if (!lblState.image) return;
            const currentItem = lblState.images[lblState.currentIndex];

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'save_annotations',
                imagePath: currentItem.path,
                annotations: lblState.annotations,
                width: lblState.imgW,
                height: lblState.imgH,
                labels: lblState.labels
            }));
        }

        // --- UI Rendering ---
        function renderLabelList() {
            const container = document.getElementById('labelListContainer');
            container.innerHTML = '';
            lblState.labels.forEach((lbl, idx) => {
                const el = document.createElement('div');
                el.className = `label-chip ${idx === lblState.activeLabelIndex ? 'active' : ''}`;
                el.onclick = () => {
                    lblState.activeLabelIndex = idx;
                    renderLabelList();
                };
                el.innerHTML = `<span>${idx}: ${lbl}</span>`;
                container.appendChild(el);
            });
        }

        function renderAnnotationList() {
            const container = document.getElementById('annotationListContainer');
            container.innerHTML = '';
            lblState.annotations.forEach((ann, idx) => {
                const el = document.createElement('div');
                el.className = 'label-chip'; // reuse style
                const labelName = lblState.labels[ann.labelIndex] || ann.labelIndex;
                el.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span style="font-weight:bold; margin-right:6px;">${labelName}</span>
                    </div>
                    <span onclick="deleteAnnotation(${idx})" style="color:#FF1744; cursor:pointer;">√ó</span>
                `;
                container.appendChild(el);
            });
        }

        function deleteAnnotation(idx) {
            lblState.annotations.splice(idx, 1);
            renderAnnotationList();
            renderCanvas();
            saveAnnotations();
        }

        function addLabel() {
            const name = prompt("ËæìÂÖ•Êñ∞Á±ªÂà´ÂêçÁß∞ (English):");
            if (name && !lblState.labels.includes(name)) {
                lblState.labels.push(name);
                renderLabelList();
            }
        }

        // Message Handling Extensions
        const originalMsgHandler = window.chrome.webview.removeEventListener ? null : null; // Just extending logic
        window.chrome.webview.addEventListener('message', event => {
            const data = JSON.parse(event.data);

            if (data.action === 'labeling_folder_loaded') {
                lblState.images = data.images.map(p => ({
                    path: p,
                    name: p.split(/[\\/]/).pop(),
                    status: 'new'
                }));
                // Render List
                const container = document.getElementById('labelingImageList');
                container.innerHTML = '';
                lblState.images.forEach((img, idx) => {
                    const el = document.createElement('div');
                    el.className = 'image-list-item';
                    el.innerText = img.name;
                    el.onclick = () => loadImage(idx);
                    container.appendChild(el);
                });

                // Load Labels if provided
                if (data.labels) {
                    lblState.labels = data.labels;
                    renderLabelList();
                }
            }
            else if (data.action === 'sam_models_loaded') {
                const select = document.getElementById('samModelSelect');
                if (select) {
                    const currentVal = select.value;
                    select.innerHTML = '';
                    if (data.models && data.models.length > 0) {
                        data.models.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m;
                            opt.innerText = m;
                            select.appendChild(opt);
                        });
                        // Â∞ΩÈáè‰øùÊåÅ‰πãÂâçÁöÑÈÄâÊã©
                        if (data.models.includes(currentVal)) {
                            select.value = currentVal;
                        }
                    } else {
                        const opt = document.createElement('option');
                        opt.value = "";
                        opt.innerText = "Êú™ÊâæÂà∞Ê®°Âûã";
                        select.appendChild(opt);
                    }
                }
                // Â¶ÇÊûúÊúâÂæÖÊâßË°åÁöÑËá™Âä®Âä†ËΩΩÔºåÁé∞Âú®ÊâßË°å
                if (lblState.pendingAutoLoad && data.models && data.models.length > 0) {
                    lblState.pendingAutoLoad = false;
                    const btn = document.getElementById('btnLoadModel');
                    if (btn && !btn.disabled) {
                        loadSAMModel();
                    }
                }
            }
            else if (data.action === 'sam_model_loaded') {
                lblState.samLoaded = true;
                lblState.currentModel = data.modelName || 'unknown';
                const btn = document.getElementById('btnLoadModel');
                btn.disabled = false; // ‰øùÊåÅÂèØÁÇπÂáªÁä∂ÊÄÅ‰ª•‰æøÂàáÊç¢Ê®°Âûã
                btn.innerText = "‚úì " + lblState.currentModel;
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                showMiniToast('success', 'Ê®°ÂûãÂä†ËΩΩÊàêÂäü', lblState.currentModel + ' Â∑≤ÂáÜÂ§áÂ∞±Áª™');

                // [Fix] Â¶ÇÊûúÂΩìÂâçÂ∑≤ÊúâÂõæÁâáÔºåÈáçÊñ∞Ëß¶ÂèëÁºñÁ†Å (Reload Encoding if image exists)
                if (lblState.image) {
                    addLog("Ê£ÄÊµãÂà∞Â∑≤Âä†ËΩΩÂõæÁâáÔºåÊ≠£Âú®ÈáçÊñ∞ÈÄöËøáÊ®°ÂûãÁºñÁ†Å...", "info");
                    // ÈáçÊñ∞ÂèëÈÄÅ encode_image ËØ∑Ê±Ç
                    window.chrome.webview.postMessage(JSON.stringify({
                        action: 'encode_image',
                        path: lblState.images[lblState.currentIndex].path
                    }));
                }
            }
            else if (data.action === 'sam_result') {
                // data.bbox = {x, y, w, h}
                lblState.tempBox = data.bbox;
                renderCanvas();
            }
            else if (data.action === 'image_encoded') {
                document.getElementById('canvasInfo').innerText = "Ready";
                // If existed annotations returned
                if (data.existing && data.existing.length > 0) {
                    lblState.annotations = data.existing;
                    renderCanvas();
                    renderAnnotationList();
                }
            }
            else if (data.action === 'image_data_loaded') {
                // Base64 Loaded
                const img = new Image();
                img.onload = () => {
                    lblState.image = img;
                    lblState.imgW = img.width;
                    lblState.imgH = img.height;

                    // Fit to view
                    const wrapper = document.getElementById('canvasWrapper');
                    if (wrapper) {
                        const scaleX = wrapper.clientWidth / img.width;
                        const scaleY = wrapper.clientHeight / img.height;
                        lblState.scale = Math.min(scaleX, scaleY) * 0.9;
                        lblState.offset.x = (wrapper.clientWidth - img.width * lblState.scale) / 2;
                        lblState.offset.y = (wrapper.clientHeight - img.height * lblState.scale) / 2;
                    }

                    // Clear state
                    lblState.prompts = [];
                    lblState.tempBox = null;
                    lblState.annotations = [];

                    // Request Encode (for SAM2 backend)
                    if (lblState.samLoaded) {
                        window.chrome.webview.postMessage(JSON.stringify({
                            action: 'encode_image',
                            path: data.path
                        }));
                    } else {
                        addLog("Ê®°ÂûãÂ∞öÊú™Âä†ËΩΩÔºåÊöÇ‰∏çËøõË°åÁºñÁ†Å (Model not ready)", "info");
                    }

                    renderCanvas();
                };
                img.src = "data:image/jpeg;base64," + data.base64;
            }
        });


        setTimeout(() => {
            loadProjects();
            loadPythonPath();
        }, 500); // Trigger auto load
    </script>
</body>

</html>