<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight Â· ç§‹æ¯«V4</title>
    <style>
        :root {
            /* æ ¸å¿ƒè‰²æ¿ - é›…éŸµ (Elegant Ink) - äº®è‰²æ¨¡å¼ */
            --primary: #00897B;
            /* ç«¹é’ (Bamboo Teal) - æ²‰ç¨³é›…è‡´ */
            --primary-light: #4DB6AC;
            /* æµ…ç«¹ (Light Bamboo) */
            --primary-dark: #004D40;
            /* æ·±ç«¹ (Deep Bamboo) */

            /* èƒŒæ™¯è‰²æ¿ - å®£çº¸ (Rice Paper) */
            --bg-body: #F5F7FA;
            /* ææµ…ç°ç™½ (Paper White) - ç½‘é¡µèƒŒæ™¯ */
            --bg-card: #FFFFFF;
            /* çº¯ç™½ (Pure White) - å¡ç‰‡èƒŒæ™¯ */
            --bg-card-light: #F0F2F5;
            /* æµ…ç° (Light Grey) - è¾“å…¥æ¡†/æ¬¡çº§èƒŒæ™¯ */

            /* æ–‡å­—è‰²æ¿ - å¾½å¢¨ (Hui Ink) */
            --text-main: #263238;
            /* å¢¨é»‘ (Ink Black) - ä¸»æ–‡å­— */
            --text-sub: #546E7A;
            /* çŸ³é’ (Stone Blue) - æ¬¡çº§æ–‡å­— */

            /* åŠŸèƒ½è‰² */
            --border-color: #E0E0E0;
            /* æµ…ç°è¾¹æ¡† */
            --border-glow: rgba(0, 137, 123, 0.05);
            /* ææ·¡çš„é’å…‰ */
            --sidebar-width: 240px;
            --danger: #D32F2F;
            /* ä¸¹çº¢ (Cinnabar) */
            --success: #388E3C;
            /* è‰ç»¿ (Grass) */
            --warning: #FFA000;
            /* è—¤é»„ (Gamboge) */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* ä¼˜åŒ–å­—ä½“æ¸²æŸ“ï¼Œå¢å¼ºå›½é£è´¨æ„Ÿ */
            font-family: "PingFang SC", "Microsoft YaHei UI", "Microsoft YaHei", "Segoe UI", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            /* å®£çº¸çº¹ç†æ„Ÿ - ææ·¡çš„æš–è‰²æ™•æŸ“ */
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 137, 123, 0.03) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 77, 64, 0.02) 0%, transparent 40%);
        }

        /* Sidebar Styles - ç®€çº¦é›…è‡´ (Elegant Simple) */
        .sidebar {
            width: var(--sidebar-width);
            background: #FFFFFF;
            /* çº¯ç™½èƒŒæ™¯ */
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 10;
            /* æŸ”å’Œçš„é˜´å½± */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.02);
            backdrop-filter: none;
            /* ç§»é™¤ç£¨ç ‚ï¼Œä¿æŒæ¸…æ™° */
        }

        .brand {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
            /* ç§»é™¤éœ“è™¹å‘å…‰ï¼Œæ”¹ç”¨å¹²å‡€çš„æ–‡å­— */
            text-shadow: none;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-sub);
            font-weight: 600;
            font-size: 15px;
            background: transparent;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .nav-item:hover {
            background: rgba(0, 137, 123, 0.05);
            /* ææ·¡çš„ç«¹é’è‰² */
            color: var(--primary);
            /* border-color: rgba(0, 137, 123, 0.1); */
        }

        .nav-item.active {
            background: rgba(0, 137, 123, 0.08);
            color: var(--primary);
            border: 1px solid transparent;
            /* ä¹¦ç­¾æ ·å¼å·¦ä¾§é«˜äº® */
            border-left: 3px solid var(--primary);
        }

        .nav-icon {
            font-size: 18px;
            color: var(--text-sub);
            /* å›¾æ ‡é»˜è®¤ç°è‰² */
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
            /* æ¿€æ´»æ—¶å˜è‰² */
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            position: relative;
            background: transparent;
            /* é€æ˜èƒŒæ™¯ï¼Œé€å‡ºbodyçš„å®£çº¸çº¹ç† */
        }

        /* Custom Scrollbar */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #B0BEC5;
            border-radius: 4px;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        .view-container {
            display: none;
            height: 100%;
            flex-direction: column;
            gap: 24px;
            animation: fadeScale 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .view-container.active {
            display: flex;
        }

        @keyframes fadeScale {
            from {
                opacity: 0;
                transform: scale(0.99);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Configuration Layout */
        .config-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            /* Fixed Left, Fluid Right */
            gap: 24px;
            height: 100%;
        }

        .panel-col {
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 100%;
        }

        /* Modern Cards - Elegant Style */
        .card {
            background: #FFFFFF;
            /* çº¯ç™½å¡ç‰‡ */
            border-radius: 12px;
            padding: 24px;
            /* æŸ”å’Œçš„å¢¨æ™•é˜´å½± */
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04),
                0 1px 4px rgba(0, 0, 0, 0.02);
            border: 1px solid var(--border-color);
            /* æ¸…æ™°çš„æµ…ç°è¾¹æ¡† */
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-light);
            box-shadow: 0 8px 24px rgba(0, 137, 123, 0.08);
            /* æ‚¬åœæ—¶æ·¡æ·¡çš„é’å…‰ */
        }

        .card.fill-height {
            flex: 1;
            overflow: hidden;
        }

        .card-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            /* ç«¹é’è‰²è£…é¥°æ¡ */
            background: var(--primary);
            border-radius: 2px;
            margin-right: 12px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-sub);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #F9FAFB;
            /* ææµ…ç°èƒŒæ™¯ */
            color: var(--text-main);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: #FFFFFF;
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 137, 123, 0.1);
            /* æŸ”å’Œçš„å¯¹ç„¦å…‰ç¯ */
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        /* Buttons - Elegant Style */
        .btn {
            border: 1px solid transparent;
            cursor: pointer;
            padding: 10px 22px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            /* æ²‰ç¨³çš„ç«¹é’è‰²æ¸å˜ */
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            color: #fff;
            box-shadow: 0 2px 6px rgba(0, 137, 123, 0.2);
            border: none;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 137, 123, 0.3);
        }

        .btn-secondary {
            background: #FFFFFF;
            color: var(--text-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #FAFAFA;
        }

        .btn-danger {
            background: linear-gradient(145deg, #EF5350, #C62828);
            color: white;
            box-shadow: 0 2px 6px rgba(198, 40, 40, 0.2);
        }

        .btn-danger:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
        }

        .btn-icon {
            padding: 10px;
        }

        /* Checklist */
        .checklist-container {
            border: 1px solid var(--border-color);
            background: #FAFAFA;
            border-radius: 8px;
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        /* Custom Scrollbar for Checklist */
        .checklist-container::-webkit-scrollbar {
            width: 6px;
        }

        .checklist-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .checklist-container::-webkit-scrollbar-thumb {
            background: #CFD8DC;
            border-radius: 3px;
        }

        .checklist-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #FFFFFF;
            border: 1px solid transparent;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .checklist-item:hover {
            border-color: var(--primary-light);
            background: #F0FDF4;
            /* ææ·¡çš„ç»¿è‰²èƒŒæ™¯ */
        }

        .checklist-item input {
            margin-right: 12px;
            accent-color: var(--primary);
            width: 16px;
            height: 16px;
            transition: all 0.2s ease;
        }

        .checklist-item input:checked {
            /* æµè§ˆå™¨é»˜è®¤è¡Œä¸ºå³å¯ï¼Œé…åˆ accent-color */
        }

        .checklist-item label {
            font-size: 14px;
            color: var(--text-main);
            cursor: pointer;
            flex: 1;
        }

        /* Grid for Params */
        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        /* Switches */
        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #F9FAFB;
            /* æµ…ç°èƒŒæ™¯ */
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .switch-row span {
            white-space: nowrap;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-main);
        }

        .switch {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
            /* é˜²æ­¢å¼€å…³è¢«å‹ç¼© */
            margin-left: 12px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #CFD8DC;
            transition: all 0.3s ease;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: all 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background: var(--primary);
            box-shadow: none;
        }

        input:checked+.slider:before {
            transform: translateX(18px);
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Monitor View - Elegant Theme */
        .monitor-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .kpi-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-light);
            box-shadow: 0 8px 20px rgba(0, 137, 123, 0.08);
        }

        .kpi-title {
            font-size: 13px;
            color: var(--text-sub);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-top: 8px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            letter-spacing: -0.5px;
            text-shadow: none;
        }

        .chart-row {
            flex: 1;
            background: #FFFFFF;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
            min-height: 0;
            position: relative;
        }

        .log-row {
            height: 200px;
            background: #263238;
            /* ä¿æŒæ·±è‰²ç»ˆç«¯æ„Ÿï¼Œå¯¹æ¯”å¼ºçƒˆ */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .console-log {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #CFD8DC;
            background: transparent;
        }

        /* Custom Scrollbar for Console */
        .console-log::-webkit-scrollbar {
            width: 6px;
        }

        .console-log::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .console-log::-webkit-scrollbar-thumb {
            background: #546E7A;
            border-radius: 3px;
        }

        .status-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #B0BEC5;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Modal - Elegant Style */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(38, 50, 56, 0.6);
            /* æ·±è‰²é®ç½© */
            backdrop-filter: blur(4px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: #FFFFFF;
            width: 500px;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: none;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Success Notification Toast - Elegant Style */
        .success-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: #FFFFFF;
            padding: 40px 60px;
            border-radius: 16px;
            z-index: 200;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid #E0E0E0;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        .success-toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .success-toast-icon {
            font-size: 64px;
            margin-bottom: 24px;
            animation: bounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: none;
            /* ç§»é™¤å‘å…‰ */
        }

        .success-toast-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 12px;
            text-shadow: none;
        }

        .success-toast-message {
            font-size: 15px;
            color: var(--text-sub);
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .success-toast-close {
            background: var(--success);
            border: none;
            padding: 12px 40px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(56, 142, 60, 0.2);
        }

        .success-toast-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 142, 60, 0.3);
            filter: brightness(1.1);
        }

        @keyframes bounce {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .success-toast-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(38, 50, 56, 0.5);
            backdrop-filter: blur(2px);
            z-index: 199;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .success-toast-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Log Styles */
        .log-item {
            margin-bottom: 4px;
            padding: 2px 0;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }

        .log-time {
            color: #78909C;
            margin-right: 10px;
        }

        .log-info {
            color: #CFD8DC;
        }

        .log-error {
            color: #EF5350;
        }

        .log-success {
            color: #66BB6A;
        }

        .log-warning {
            color: #FFA726;
        }

        /* Progress Bar */
        .progress-bar {
            transition: width 0.3s ease;
            background: var(--primary);
            box-shadow: none;
        }

        /* Table Styles - Elegant Ledger */
        .training-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            color: var(--text-main);
            font-size: 14px;
        }

        .training-table th {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            /* åŠ é‡æ ‡é¢˜çº¿ */
            color: var(--text-sub);
            font-weight: 600;
        }

        .training-table td {
            padding: 14px 12px;
            border-bottom: 1px dashed var(--border-color);
            /* è™šçº¿åˆ†éš” */
            transition: all 0.2s;
        }

        .training-table tr:last-child td {
            border-bottom: none;
        }

        .training-table tr:hover td {
            background: rgba(0, 137, 123, 0.03);
            /* ææ·¡çš„é’è‰²æ‚¬åœ */
        }

        /* Mini Toast - å³ä¸Šè§’é€šçŸ¥æ  */
        .mini-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00897B, #26A69A);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 300;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px rgba(0, 137, 123, 0.3);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 400px;
        }

        .mini-toast.show {
            transform: translateX(0);
        }

        .mini-toast-icon {
            font-size: 24px;
        }

        .mini-toast-content {
            flex: 1;
        }

        .mini-toast-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .mini-toast-message {
            font-size: 12px;
            opacity: 0.9;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="brand"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
                <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>Insight Â· ç§‹æ¯«V4 </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('config')" id="nav-config"><span
                    class="nav-icon">âš™ï¸</span><span>ä»»åŠ¡é…ç½®</span></div>
            <div class="nav-item" onclick="switchTab('monitor')" id="nav-monitor"><span
                    class="nav-icon">ğŸ“ˆ</span><span>è®­ç»ƒç›‘æ§</span></div>
            <div class="nav-item" onclick="switchTab('tools')" id="nav-tools"><span
                    class="nav-icon">ğŸ› ï¸</span><span>æ•°æ®è½¬æ¢</span></div>
            <div class="nav-item" onclick="switchTab('models')" id="nav-models"><span
                    class="nav-icon">ğŸ“¦</span><span>è®­ç»ƒå†å²</span></div>
        </div>
        <div style="flex: 1;"></div>
        <div style="font-size: 12px; color: var(--text-sub); text-align: center; margin-top: 20px;">v2.1.0 Build
            2025 </div>
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <!-- View: Configuration -->
        <div id="view-config" class="view-container active">
            <div class="config-layout">
                <!-- Left Column: Data Source Mgmt -->
                <div class="panel-col">
                    <div class="card fill-height">
                        <div class="card-header"><span>é¡¹ç›®ä¸æ•°æ®æº</span><button class="btn btn-secondary btn-icon"
                                onclick="loadProjects()" title="åˆ·æ–°é¡¹ç›®">ğŸ”„</button><button
                                class="btn btn-primary btn-icon" onclick="openCreateProjectModal()" title="æ–°å»ºé¡¹ç›®"
                                style="margin-left: 8px;">ï¼‹</button><button class="btn btn-danger btn-icon"
                                onclick="deleteProject()" title="åˆ é™¤å½“å‰é¡¹ç›®" style="margin-left: 8px;">ğŸ—‘ï¸</button></div>
                        <div class="form-group"><label class="form-label">å½“å‰é¡¹ç›® (Project)</label><select
                                id="projectSelect" class="form-control" onchange="onProjectChanged()">
                                <option value="">æ­£åœ¨åŠ è½½...</option>
                            </select></div>
                        <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                            <label class="form-label">æ•°æ®æºåŠ è½½ (Checklist)</label>
                            <div id="dataSourceList" class="checklist-container">
                                <div style="text-align: center; padding: 20px; color: #aaa; font-size: 13px;">
                                    è¯·é€‰æ‹©é¡¹ç›® </div>
                            </div>
                        </div>
                        <div class="form-group"><label class="form-label">è¾“å‡ºè·¯å¾„ (Workspace)</label><input type="text"
                                id="targetPath" class="form-control" readonly style="font-size: 12px; opacity: 0.8;">
                        </div>
                    </div>
                </div>
                <!-- Right Column: Training Params -->
                <div class="panel-col">
                    <div class="card">
                        <div class="card-header"><span>YOLO è®­ç»ƒå‚æ•°</span><button class="btn btn-secondary"
                                onclick="openAugmentModal()" style="font-size: 12px;">ğŸ› ï¸ ç¼ºé™·å¢å¼º </button></div>
                        <div class="params-grid">
                            <div class="form-group"><label class="form-label">æ¨¡å‹å¤§å°</label><select id="modelSize"
                                    class="form-control">
                                    <optgroup label="YOLOv8">
                                        <option value="v8n">Nano (v8n)</option>
                                        <option value="v8s" selected>Small (v8s)</option>
                                        <option value="v8m">Medium (v8m)</option>
                                        <option value="v8l">Large (v8l)</option>
                                    </optgroup>
                                    <optgroup label="YOLOv11">
                                        <option value="v11n">Nano (v11n)</option>
                                        <option value="v11s">Small (v11s)</option>
                                        <option value="v11m">Medium (v11m)</option>
                                    </optgroup>
                                    <optgroup label="YOLO26">
                                        <option value="v26n">Nano (v26n)</option>
                                        <option value="v26s">Small (v26s)</option>
                                        <option value="v26m">Medium (v26m)</option>
                                        <option value="v26l">Large (v26l)</option>
                                        <option value="v26x">X-Large (v26x)</option>
                                    </optgroup>
                                </select></div>
                            <div class="form-group"><label class="form-label">å›¾ç‰‡å°ºå¯¸
                                    (ImgSz)</label><input type="number" id="imgSize" class="form-control" value="640"
                                    step="32"></div>
                            <div class="form-group"><label class="form-label">Batch
                                    Size</label><input type="number" id="batchSize" class="form-control" value="16"
                                    placeholder="Auto (-1)"></div>
                            <div class="form-group"><label class="form-label">Epochs</label><input type="number"
                                    id="epochs" class="form-control" value="300">
                            </div>
                            <div class="form-group"><label class="form-label">Patience</label><input type="number"
                                    id="patience" class="form-control" value="50">
                            </div>
                            <div class="form-group"><label class="form-label">Worker
                                    Threads</label><input type="number" id="workers" class="form-control" value="8">
                            </div>
                            <div class="form-group"><label class="form-label">GPU
                                    Index</label><input type="text" id="gpuIndex" class="form-control" value="0">
                            </div>
                        </div>
                        <div class="params-grid" style="margin-top: 10px;">
                            <div class="switch-row">
                                <span>P2 å°ç›®æ ‡å¢å¼º</span>
                                <label class="switch"><input type="checkbox" id="enableP2"><span
                                        class="slider"></span></label>
                            </div>
                            <div class="switch-row">
                                <span>è‡ªåŠ¨ä¿®æ­£å›¾ç‰‡</span>
                                <label class="switch"><input type="checkbox" id="autoFixImage" checked><span
                                        class="slider"></span></label>
                            </div>
                        </div>

                        <!-- Model Management Config -->
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color);">
                            <div class="params-grid">
                                <div class="form-group">
                                    <label class="form-label">è‡ªå®šä¹‰æ¨¡å‹åç§° (ONNX Name) <span
                                            style="color: var(--text-sub); font-weight: normal; font-size: 12px;">(ä¸ºç©ºåˆ™è‡ªåŠ¨å‘½å)</span></label>
                                    <input type="text" id="customOnnxName" class="form-control"
                                        placeholder="ä¾‹å¦‚: MyModel-v1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">æ¨¡å‹ä¿å­˜ç›®å½• (Storage Path)</label>
                                    <div class="input-group">
                                        <input type="text" id="modelStoragePath" class="form-control" readonly
                                            placeholder="é»˜è®¤: é¡¹ç›®æ ¹ç›®å½•/models">
                                        <button class="btn btn-secondary"
                                            onclick="selectFolder('modelStorage')">ğŸ“</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 24px;"><button id="btnGenerate" class="btn btn-primary"
                                onclick="startGenerate()" style="width: 100%;">âœ¨ ç”Ÿæˆæ•°æ®é›† (Generate) </button>
                            <div id="statusMessage"
                                style="text-align: center; margin-top: 10px; font-size: 13px; color: var(--text-sub); height: 20px;">
                            </div>
                        </div>
                    </div>
                    <div class="card" style="flex: 0;">
                        <div class="card-header"><span>æ‰§è¡Œæ§åˆ¶</span></div>
                        <div class="form-group">
                            <div class="input-group"><input type="text" id="pythonPath" class="form-control"
                                    value="C:\conda_envs\yolo\python.exe" placeholder="Python Environment Path..."
                                    onchange="savePythonPath(this.value)"><button class="btn btn-secondary"
                                    onclick="selectFolder('python')" title="æµè§ˆæ–‡ä»¶å¤¹">ğŸ“</button><button
                                    class="btn btn-secondary" onclick="saveAsDefaultPythonPath()" title="ä¿å­˜ä¸ºé»˜è®¤åœ°å€"
                                    style="margin-left: 4px;">ğŸ’¾ è®¾ä¸ºé»˜è®¤</button></div>
                        </div>
                        <div style="display: flex; gap: 16px;"><button id="btnStartTrain" class="btn btn-primary"
                                onclick="startTraining()" style="flex: 2;">ğŸš€ å¼€å§‹è®­ç»ƒ</button><button id="btnStopTrain"
                                class="btn btn-danger" onclick="stopTraining()" disabled style="flex: 1;">â¹
                                åœæ­¢</button><button id="btnOpenOutput" class="btn btn-secondary"
                                onclick="openOutputFolder()" style="display: none;">ğŸ“‚ ç»“æœ</button></div>
                    </div>
                    <!-- Layout Optimization: System Status & Mini Log -->
                    <!-- Flex-grow to fill the remaining vertical space -->
                    <div class="card" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div class="card-header"><span>ç³»ç»ŸçŠ¶æ€ä¸æ—¥å¿— (System Status)</span><span
                                style="font-size: 11px; color: var(--text-sub);">Live</span>
                        </div>
                        <!-- Status Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                            <div
                                style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                                <div style="font-size: 18px;">ğŸ</div>
                                <div>
                                    <div style="font-size: 10px; color: var(--text-sub);">
                                        Python Environment</div>
                                    <div style="font-size: 12px; font-weight: 600; color: #0be881;">
                                        Detected</div>
                                </div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                                <div style="font-size: 18px;">ğŸ®</div>
                                <div>
                                    <div style="font-size: 10px; color: var(--text-sub);">
                                        GPU Acceleration</div>
                                    <div style="font-size: 12px; font-weight: 600; color: #0be881;" id="gpuStatus">
                                        Ready </div>
                                </div>
                            </div>
                            <!-- More metrics can be added here -->
                        </div>
                        <!-- Mini Console -->
                        <div style="flex: 1; background: #000; border-radius: 6px; padding: 10px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 11px; color: #dcdde1;"
                            id="configConsole">
                            <div style="color: #7f8fa4;">>System initialized...
                            </div>
                            <div style="color: #7f8fa4;">>Waiting for commands...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- View: Monitor -->
        <div id="view-monitor" class="view-container">
            <div class="monitor-layout">
                <!-- KPI Cards -->
                <div class="kpi-row">
                    <div class="kpi-card">
                        <div class="kpi-title">ğŸ”„ Epochs</div>
                        <div class="kpi-value" id="kpi-epoch">0/0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">ğŸ¯ Box Loss</div>
                        <div class="kpi-value" id="kpi-loss" style="color: #d98e84;">0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">ğŸ“ˆ mAP50</div>
                        <div class="kpi-value" id="kpi-map50" style="color: #8cb6a8;">0.00</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">ğŸš€ mAP50-95</div>
                        <div class="kpi-value" id="kpi-map95" style="color: #e6c587;">0.00</div>
                    </div>
                </div>
                <!-- Main Chart -->
                <div class="chart-row"><canvas id="trainingChart"></canvas></div>
                <!-- Terminal & Progress -->
                <div class="log-row">
                    <div class="status-header">
                        <div style="display:flex; gap:15px;"><span id="progressStatus">Ready</span><span
                                id="progressETA" style="color: #0be881;"></span></div><span
                            id="progressPercent">0%</span>
                    </div>
                    <div style="height: 4px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar" id="progressFill" style="height:100%; width:0%; background:#0be881;">
                        </div>
                    </div>
                    <div class="console-log" id="console">
                        <div class="log-item"><span class="log-time">[System]</span>Ready to train.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- View: Tools (Data Converter) -->
        <div id="view-tools" class="view-container">
            <div class="card">
                <div class="card-header"><span>LabelMe è½¬ YOLO (Converter)</span></div>
                <div class="form-group"><label class="form-label">æºæ–‡ä»¶å¤¹è·¯å¾„ (LabelMe JSONs +
                        Images)</label>
                    <div class="input-group"><input type="text" id="toolSourcePath" class="form-control"
                            placeholder="é€‰æ‹©åŒ…å« JSON å’Œå›¾ç‰‡çš„æ–‡ä»¶å¤¹..."><button class="btn btn-secondary"
                            onclick="selectFolder('toolSource')">ğŸ“</button></div>
                </div>
                <div class="form-group"><label class="form-label">ç›®æ ‡ä¿å­˜è·¯å¾„ (Output Folder)</label>
                    <div class="input-group"><input type="text" id="toolTargetPath" class="form-control"
                            placeholder="é€‰æ‹©è½¬æ¢ç»“æœä¿å­˜ä½ç½®..."><button class="btn btn-secondary"
                            onclick="selectFolder('toolTarget')">ğŸ“</button></div>
                </div>
                <div style="margin-top: 24px;"><button class="btn btn-primary" onclick="startToolConversion()"
                        style="width: 100%;">ğŸš€ å¼€å§‹è½¬æ¢ (Start
                        Conversion) </button></div>
            </div>
            <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                <div class="card-header"><span>è½¬æ¢æ—¥å¿— (Log)</span></div>
                <div class="console-log" id="toolConsole" style="background: #1e272e; border-radius: 12px;">
                    <div class="log-item"><span class="log-time">[System]</span>Ready for
                        conversion.</div>
                </div>
            </div>
        </div>

        <!-- View: Training History (Simplified) -->
        <div id="view-models" class="view-container">
            <div class="card fill-height">
                <div class="card-header">
                    <span>è®­ç»ƒå†å² (Training History)</span>
                    <button class="btn btn-secondary btn-icon" onclick="loadTrainingHistory()" title="åˆ·æ–°å†å²">ğŸ”„</button>
                </div>

                <div class="checklist-container">
                    <table class="training-table">
                        <thead>
                            <tr>
                                <th>é¡¹ç›® (Project)</th>
                                <th>é…ç½® (Config)</th>
                                <th>è®­ç»ƒæŒ‡æ ‡ (Metrics)</th>
                                <th style="width: 150px;">æ—¶é—´ (Date)</th>
                                <th style="width: 60px; text-align: center;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="trainingHistoryBody">
                            <!-- Training history entries will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-bottom: 24px; color: var(--text-main);">æ–°å»ºé¡¹ç›®
                (Create Project)</h3>
            <div class="form-group"><label class="form-label">é¡¹ç›®åç§° (Name)</label><input type="text" id="newProjectName"
                    class="form-control" placeholder="ä¾‹å¦‚: Screw Detection"></div>
            <div class="form-group"><label class="form-label">é¡¹ç›®æ ¹ç›®å½• (Root Path)</label>
                <div class="input-group"><input type="text" id="newProjectRoot" class="form-control" readonly
                        placeholder="é€‰æ‹©ç©ºæ–‡ä»¶å¤¹æˆ–ç°æœ‰æ•°æ®æ–‡ä»¶å¤¹..."><button class="btn btn-secondary"
                        onclick="selectFolder('newProjectRoot')">ğŸ“</button></div>
            </div>
            <div class="form-group"><label class="form-label">åŒ…å«ç±»åˆ« (Classes)</label><input type="text"
                    id="newProjectClasses" class="form-control" placeholder="ç”¨é€—å·åˆ†éš”, ä¾‹å¦‚: screw, nut, ng">
                <p style="font-size: 12px; color: #999; margin-top: 4px;">* å¯¹åº” YOLO data.yaml ä¸­çš„ names</p>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;"><button
                    class="btn btn-secondary" onclick="closeCreateProjectModal()">å–æ¶ˆ</button><button
                    class="btn btn-primary" onclick="createProject()">åˆ›å»º</button></div>
        </div>
    </div>
    <!-- Modals -->
    <div id="augmentModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-bottom: 24px; color: var(--primary); text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);">ç¼ºé™·æ ·æœ¬å¢å¼º
            </h3>
            <div class="form-group"><label class="form-label">æºè·¯å¾„ (Source)</label>
                <div class="input-group"><input type="text" id="augmentSourcePath" class="form-control" readonly><button
                        class="btn btn-secondary" onclick="selectFolder('augmentSource')">ğŸ“</button></div>
            </div>
            <div class="form-group"><label class="form-label">ç´ æè·¯å¾„ (Defect Assets)</label>
                <div class="input-group"><input type="text" id="holeAssetsPath" class="form-control" readonly><button
                        class="btn btn-secondary" onclick="selectFolder('holeAssets')">ğŸ“</button></div>
            </div>
            <div class="form-group"><label class="form-label">ç”Ÿæˆæ¯”ä¾‹: <span id="mutationRateVal">30%</span></label><input
                    type="range" id="mutationRate" style="width: 100%; accent-color: var(--primary);" min="10" max="80"
                    value="30" oninput="document.getElementById('mutationRateVal').innerText = this.value + '%'">
            </div>
            <div style="background: #f5f5f5; border-radius: 8px; height: 6px; overflow: hidden; margin: 20px 0;">
                <div id="augmentFill"
                    style="background: var(--primary); width: 0%; height: 100%; transition: width 0.3s;">
                </div>
            </div>
            <div id="augmentStatus"
                style="font-size: 12px; color: var(--text-sub); margin-bottom: 20px; text-align: center;">
                Wait</div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;"><button class="btn btn-secondary"
                    onclick="closeAugmentModal()">å–æ¶ˆ</button><button class="btn btn-primary"
                    onclick="startAugmentation()">å¼€å§‹ç”Ÿæˆ</button></div>
        </div>
    </div>
    <!-- Success Notification Toast -->
    <div id="successToastOverlay" class="success-toast-overlay"></div>
    <div id="successToast" class="success-toast">
        <div class="success-toast-icon">ğŸ‰</div>
        <div class="success-toast-title" id="successToastTitle">æ“ä½œå®Œæˆï¼</div>
        <div class="success-toast-message" id="successToastMessage">æ•°æ®é›†ç”Ÿæˆå·²æˆåŠŸå®Œæˆ</div>
        <button class="success-toast-close" onclick="hideSuccessToast()">ç¡®å®š</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script> // ========== Tabs Management ==========

        function switchTab(viewId) {
            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + viewId).classList.add('active');

            // Update View
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');

            if (viewId === 'monitor' && chartInstance) {
                setTimeout(() => chartInstance.resize(), 100);
            }

            if (viewId === 'models') {
                loadTrainingHistory();
            }
        }

        // ========== Project Management ==========
        let currentProjects = [];
        let currentProjectConfig = null;

        function loadProjects() {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_projects'
            }));
        }

        function onProjectChanged() {
            const select = document.getElementById('projectSelect');
            const idx = select.selectedIndex;

            if (idx >= 0 && currentProjects[idx]) {
                currentProjectConfig = currentProjects[idx];

                // Update Target Path (Constructed)
                const workspace = currentProjectConfig.RootPath + "\\dataset";
                document.getElementById('targetPath').value = workspace;

                // Request Subfolders
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'get_subfolders',
                    path: currentProjectConfig.RootPath
                }));
            }
        }

        function updateProjectList(projects) {
            currentProjects = projects;
            const select = document.getElementById('projectSelect');
            select.innerHTML = '';

            projects.forEach((p, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = p.Name;
                select.appendChild(opt);
            });

            if (projects.length > 0) {
                onProjectChanged();
            }

            else {
                document.getElementById('dataSourceList').innerHTML = '<div style="padding: 20px; text-align: center; color: #aab8c2;">è¯·å…ˆåˆ›å»ºé¡¹ç›® (projects.json)</div>';
            }
        }

        function updateSubFolders(folders) {
            const list = document.getElementById('dataSourceList');
            list.innerHTML = '';

            if (!folders || folders.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #aab8c2;">æœªæ‰¾åˆ°å­æ–‡ä»¶å¤¹</div>';
                return;
            }

            folders.forEach(folder => {
                const item = document.createElement('div');
                item.className = 'checklist-item';

                item.onclick = function (e) {
                    if (e.target.type !== 'checkbox') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                }

                    ;

                const inp = document.createElement('input');
                inp.type = 'checkbox';
                inp.value = folder;

                const lbl = document.createElement('label');
                lbl.innerText = folder;

                item.appendChild(inp);
                item.appendChild(lbl);
                list.appendChild(item);
            });
        }

        // ========== WebView2 Bridge ==========
        window.chrome.webview.addEventListener('message', event => {
            const data = JSON.parse(event.data); // Make sure backend sends stringified JSON or object

            if (data.action === 'projects_loaded') {
                updateProjectList(data.projects);
            }

            else if (data.action === 'subfolders_loaded') {
                updateSubFolders(data.folders);
            }

            else if (data.action === 'log') {
                addLog(data.message, data.type);
            }

            else if (data.action === 'training_data') {
                // data: { epoch, box_loss, map50, map5095, progress }
                updateChart(data.epoch, data.box_loss, data.map50, data.map5095);

                // Update Progress
                if (data.progress !== undefined) {
                    const pct = Math.round(data.progress) + '%';
                    document.getElementById('progressFill').style.width = pct;
                    document.getElementById('progressPercent').innerText = pct;
                    document.getElementById('progressStatus').innerText = 'Epoch: ' + data.epoch;

                    // ETA Logic
                    updateETA(data.epoch);
                }
            }

            else if (data.action === 'folder_selected') {
                if (data.type === 'python') {
                    document.getElementById('pythonPath').value = data.path;
                    savePythonPath(data.path);
                }
                else if (data.type === 'augmentSource') document.getElementById('augmentSourcePath').value = data.path;
                else if (data.type === 'holeAssets') document.getElementById('holeAssetsPath').value = data.path;
                else if (data.type === 'newProjectRoot') document.getElementById('newProjectRoot').value = data.path;
                else if (data.type === 'toolSource') document.getElementById('toolSourcePath').value = data.path;
                else if (data.type === 'toolTarget') document.getElementById('toolTargetPath').value = data.path;
                else if (data.type === 'modelStorage') {
                    document.getElementById('modelStoragePath').value = data.path;
                    localStorage.setItem('insight_model_storage_path', data.path);
                    // If we are in model tab, refresh
                    if (document.getElementById('view-models').classList.contains('active')) {
                        refreshModels();
                    }
                }
            }

            else if (data.action === 'augment_progress') {
                document.getElementById('augmentFill').style.width = data.progress + '%';
                document.getElementById('augmentPercent').innerText = data.progress + '%';
            }

            else if (data.action === 'augment_complete') {
                document.getElementById('augmentFill').style.width = '100%';
                document.getElementById('augmentPercent').innerText = '100%';

                setTimeout(() => {
                    closeAugmentModal(); addLog('Augmentation Complete', 'success');
                }

                    , 1000);
            }

            else if (data.action === 'training_finished') {
                showMiniToast('ğŸ‰', 'è®­ç»ƒå®Œæˆ', 'æ¨¡å‹è®­ç»ƒå·²æˆåŠŸå®Œæˆï¼', 'success');
                addLog('Training Finished!', 'success');
                document.getElementById('btnStartTrain').disabled = false;
                document.getElementById('btnStopTrain').disabled = true;
                document.getElementById('btnOpenOutput').style.display = 'inline-flex';
                document.getElementById('progressStatus').innerText = 'Done';
            }

            else if (data.action === 'training_stopped') {
                showMiniToast('âš ï¸', 'è®­ç»ƒå·²åœæ­¢', 'ç”¨æˆ·æ‰‹åŠ¨åœæ­¢äº†è®­ç»ƒè¿›ç¨‹', 'warning');
                addLog('Training Stopped', 'warning');
                document.getElementById('btnStartTrain').disabled = false;
                document.getElementById('btnStopTrain').disabled = true;
                document.getElementById('progressStatus').innerText = 'Stopped';
            }

            else if (data.action === 'complete') {
                // æ˜¾ç¤ºå³ä¸Šè§’é€šçŸ¥
                showMiniToast('ğŸ‰', 'æ“ä½œå®Œæˆ', data.message, 'success');
                addLog(data.message, 'success');
            }

            else if (data.action === 'error') {
                showMiniToast('âŒ', 'å‡ºé”™äº†', data.message, 'error');
                addLog(data.message, 'error');
            }

            else if (data.action === 'training_history_loaded') {
                renderTrainingHistory(data.history || []);
            }

            else if (data.action === 'python_path_saved') {
                if (data.success) {
                    showMiniToast('âœ…', 'è®¾ç½®æˆåŠŸ', 'å·²ä¿å­˜ä¸ºé»˜è®¤åœ°å€ï¼Œé‡å¯åè‡ªåŠ¨ç”Ÿæ•ˆ', 'success');
                } else {
                    showMiniToast('âŒ', 'ä¿å­˜å¤±è´¥', data.error || 'æœªçŸ¥é”™è¯¯', 'error');
                }
            }

            else if (data.action === 'default_python_path_loaded') {
                if (data.path) {
                    document.getElementById('pythonPath').value = data.path;
                }
            }
        });

        // ========== Chart Logic ==========
        var chartInstance = null;
        var trainStartTime = 0;

        function initChart() {
            var ctx = document.getElementById('trainingChart').getContext('2d');
            Chart.defaults.color = '#aab8c2';
            Chart.defaults.borderColor = 'rgba(0,0,0,0.05)';

            chartInstance = new Chart(ctx, {

                type: 'line',
                data: {

                    labels: [],
                    datasets: [{
                        label: 'Box Loss', data: [], borderColor: '#d98e84', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y'
                    }

                        ,
                    {
                        label: 'mAP50', data: [], borderColor: '#8cb6a8', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y1'
                    }

                        ,
                    {
                        label: 'mAP50-95', data: [], borderColor: '#e6c587', backgroundColor: 'transparent', tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y1'
                    }

                    ]
                }

                ,
                options: {

                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        mode: 'index', intersect: false
                    }

                    ,
                    plugins: {
                        legend: {
                            labels: {

                                color: '#636e72',
                                font: {
                                    family: "'Microsoft YaHei UI', 'Segoe UI', sans-serif", size: 12, weight: '500'
                                }

                                ,
                                usePointStyle: true,
                                boxWidth: 8,
                                padding: 20
                            }
                        }

                        ,
                        tooltip: {

                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#2d3436',
                            bodyColor: '#636e72',
                            borderColor: '#e6e8e9',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            bodyFont: {
                                family: "'Microsoft YaHei UI', sans-serif"
                            }
                        }
                    }

                    ,
                    scales: {
                        x: {
                            ticks: {
                                color: '#b2bec3', maxTicksLimit: 10
                            }

                            , grid: {
                                display: false
                            }
                        }

                        ,
                        y: {

                            type: 'linear', display: true, position: 'left',
                            title: {
                                display: true, text: 'Loss', color: '#d98e84', font: {
                                    size: 11, weight: 'bold'
                                }
                            }

                            ,
                            ticks: {
                                color: '#d98e84'
                            }

                            ,
                            grid: {
                                borderDash: [4, 4], color: 'rgba(0,0,0,0.05)'
                            }
                        }

                        ,
                        y1: {

                            type: 'linear', display: true, position: 'right',
                            title: {
                                display: true, text: 'mAP', color: '#8cb6a8', font: {
                                    size: 11, weight: 'bold'
                                }
                            }

                            ,
                            ticks: {
                                color: '#8cb6a8',
                                // è‡ªå®šä¹‰åˆ»åº¦ï¼š0.7, 0.8, 0.85, 0.9, 0.95, 1.0
                                callback: function (value) {
                                    return value.toFixed(2);
                                },
                                stepSize: 0.05
                            }

                            ,
                            grid: {
                                display: true,
                                color: 'rgba(140, 182, 168, 0.1)'
                            }

                            ,
                            min: 0.7, max: 1.0,
                            // åŠ¨æ€è°ƒæ•´èŒƒå›´ï¼ˆå¯é€‰ï¼‰
                            suggestedMin: 0.7
                        }
                    }
                }
            });
        }

        setTimeout(initChart, 200);

        function updateChart(epoch, boxLoss, map50, map5095) {
            if (!chartInstance) return;

            // é‡ç½®å›¾è¡¨ï¼ˆæ–°è®­ç»ƒå¼€å§‹æ—¶ï¼‰
            if (epoch === '1/...' || (typeof epoch === 'string' && epoch.startsWith('1/'))) {
                if (chartInstance.data.labels.length > 100) {
                    // å¦‚æœæ•°æ®ç‚¹å¤ªå¤šï¼Œåªä¿ç•™æœ€è¿‘çš„æ•°æ®ä»¥ä¼˜åŒ–æ€§èƒ½
                    chartInstance.data.labels = [];
                    chartInstance.data.datasets.forEach(d => d.data = []);
                }
            }

            // å¤„ç†éªŒè¯ç»“æœ (mAP æ•°æ®)
            if (epoch === 'val') {
                // mAP æ•°æ®æ›´æ–°æœ€åä¸€ä¸ªæ•°æ®ç‚¹çš„å¯¹åº”å€¼ï¼Œæˆ–è€…è¿½åŠ åˆ°æœ€æ–°ä½ç½®
                var len = chartInstance.data.datasets[1].data.length;
                var labelLen = chartInstance.data.labels.length;

                if (map50 !== undefined) {
                    // æ›´æ–°æˆ–å¡«å…… mAP50 æ•°æ®åˆ°å½“å‰ä½ç½®
                    while (chartInstance.data.datasets[1].data.length < labelLen) {
                        // ç”¨å‰ä¸€ä¸ªå€¼å¡«å……ï¼Œé¿å…æ›²çº¿æ–­è£‚
                        var prevVal = chartInstance.data.datasets[1].data.length > 0
                            ? chartInstance.data.datasets[1].data[chartInstance.data.datasets[1].data.length - 1]
                            : null;
                        chartInstance.data.datasets[1].data.push(prevVal);
                    }
                    // æ›´æ–°æœ€åä¸€ä¸ªå€¼
                    if (chartInstance.data.datasets[1].data.length > 0) {
                        chartInstance.data.datasets[1].data[chartInstance.data.datasets[1].data.length - 1] = map50;
                    } else {
                        chartInstance.data.datasets[1].data.push(map50);
                    }
                    document.getElementById('kpi-map50').innerText = map50.toFixed(3);
                }

                if (map5095 !== undefined) {
                    // æ›´æ–°æˆ–å¡«å…… mAP50-95 æ•°æ®åˆ°å½“å‰ä½ç½®
                    while (chartInstance.data.datasets[2].data.length < labelLen) {
                        var prevVal = chartInstance.data.datasets[2].data.length > 0
                            ? chartInstance.data.datasets[2].data[chartInstance.data.datasets[2].data.length - 1]
                            : null;
                        chartInstance.data.datasets[2].data.push(prevVal);
                    }
                    if (chartInstance.data.datasets[2].data.length > 0) {
                        chartInstance.data.datasets[2].data[chartInstance.data.datasets[2].data.length - 1] = map5095;
                    } else {
                        chartInstance.data.datasets[2].data.push(map5095);
                    }
                    document.getElementById('kpi-map95').innerText = map5095.toFixed(3);
                }
            } else {
                // å¤„ç†è®­ç»ƒæ•°æ® (Box Loss)
                chartInstance.data.labels.push(epoch);
                chartInstance.data.datasets[0].data.push(boxLoss);

                // ä¸º mAP æ›²çº¿å¡«å…… null å ä½ï¼ˆç­‰å¾…éªŒè¯æ•°æ®ï¼‰
                // ä½¿ç”¨å‰ä¸€ä¸ªå€¼æ¥ä¿æŒæ›²çº¿è¿ç»­
                var prevMap50 = chartInstance.data.datasets[1].data.length > 0
                    ? chartInstance.data.datasets[1].data[chartInstance.data.datasets[1].data.length - 1]
                    : null;
                var prevMap5095 = chartInstance.data.datasets[2].data.length > 0
                    ? chartInstance.data.datasets[2].data[chartInstance.data.datasets[2].data.length - 1]
                    : null;
                chartInstance.data.datasets[1].data.push(prevMap50);
                chartInstance.data.datasets[2].data.push(prevMap5095);

                // KPI Updates
                document.getElementById('kpi-epoch').innerText = epoch;
                if (boxLoss) document.getElementById('kpi-loss').innerText = boxLoss.toFixed(4);
            }

            // æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶æ•°æ®ç‚¹æ•°é‡ï¼Œè¶…è¿‡500ç‚¹æ—¶æŠ½æ ·æ˜¾ç¤º
            if (chartInstance.data.labels.length > 500) {
                // æ¯éš”5ä¸ªç‚¹ä¿ç•™ä¸€ä¸ª
                var step = 5;
                chartInstance.data.labels = chartInstance.data.labels.filter((_, i) => i % step === 0 || i === chartInstance.data.labels.length - 1);
                chartInstance.data.datasets.forEach(d => {
                    d.data = d.data.filter((_, i) => i % step === 0 || i === d.data.length - 1);
                });
            }

            // èŠ‚æµæ›´æ–°ï¼šæ¯10æ¬¡è°ƒç”¨åªæ›´æ–°ä¸€æ¬¡å›¾è¡¨ï¼Œå‡å°‘æ€§èƒ½å¼€é”€
            if (!window._chartUpdateCounter) window._chartUpdateCounter = 0;
            window._chartUpdateCounter++;
            if (window._chartUpdateCounter % 5 === 0 || epoch === 'val') {
                chartInstance.update('none'); // 'none' æ¨¡å¼ç¦ç”¨åŠ¨ç”»ï¼Œæé«˜æ€§èƒ½
            }
        }

        function updateETA(epochStr) {
            if (trainStartTime === 0) trainStartTime = Date.now();

            if (typeof epochStr === 'string' && epochStr.includes('/')) {
                const parts = epochStr.split('/');
                const current = parseInt(parts[0]);
                const total = parseInt(parts[1]);

                if (current > 0 && total > 0) {
                    const elapsed = (Date.now() - trainStartTime) / 1000;
                    const avg = elapsed / current;
                    const remaining = (total - current) * avg;

                    const m = Math.floor(remaining / 60);
                    const s = Math.floor(remaining % 60);

                    document.getElementById('progressETA').innerText = `ETA: ${m}m ${s}s`;
                }
            }
        }

        function addLog(msg, type = 'info') {

            // Update Status Message on Config Tab
            if (msg.includes('ç”Ÿæˆæ•°æ®é›†') || msg.includes('Processing')) {
                document.getElementById('statusMessage').innerText = msg;
                document.getElementById('statusMessage').style.color = '#7f8fa4';
            }

            if (msg.includes('å®Œæˆ') || msg.includes('Success')) {
                document.getElementById('statusMessage').innerText = msg;
                document.getElementById('statusMessage').style.color = '#00b894';
            }

            if (type === 'error') {
                document.getElementById('statusMessage').innerText = msg;
                document.getElementById('statusMessage').style.color = '#d63031';
            }

            // Sync to Main Console
            const consoleDiv = document.getElementById('console');
            const item = document.createElement('div');
            item.className = 'log-item';
            const time = new Date().toLocaleTimeString();
            let colorClass = 'log-info';
            if (type === 'error') colorClass = 'log-error';
            if (type === 'success') colorClass = 'log-success';
            if (type === 'warning') colorClass = 'log-warning';

            item.innerHTML = `<span class="log-time">[${time}]</span><span class="${colorClass}">${msg}</span>`;
            consoleDiv.appendChild(item);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;

            // Sync to Mini Console (Config Tab)
            const miniConsole = document.getElementById('configConsole');
            if (miniConsole) {
                const miniItem = document.createElement('div');
                miniItem.style.marginBottom = '2px';
                miniItem.style.color = (type === 'error') ? '#ff5252' : ((type === 'success') ? '#0be881' : '#dcdde1');
                miniItem.innerText = `>${msg}`;
                miniConsole.appendChild(miniItem);
                miniConsole.scrollTop = miniConsole.scrollHeight;
            }

            // Sync to Tool Console
            const toolConsole = document.getElementById('toolConsole');
            if (toolConsole) {
                const item = document.createElement('div');
                item.className = 'log-item';
                const time = new Date().toLocaleTimeString();

                let colorClass = 'log-info';
                if (type === 'error') colorClass = 'log-error';
                if (type === 'success') colorClass = 'log-success';

                item.innerHTML = `<span class="log-time">[${time}]</span><span class="${colorClass}">${msg}</span>`;
                toolConsole.appendChild(item);
                toolConsole.scrollTop = toolConsole.scrollHeight;
            }
        }

        // ========== Success Toast Notification ==========
        function showSuccessToast(message, title = 'æ“ä½œå®Œæˆï¼') {
            document.getElementById('successToastTitle').innerText = title;
            document.getElementById('successToastMessage').innerText = message;
            document.getElementById('successToastOverlay').classList.add('show');
            document.getElementById('successToast').classList.add('show');

            // æ’­æ”¾æç¤ºéŸ³ (å¯é€‰)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAB/f39/');
                audio.volume = 0.3;
                audio.play().catch(() => { });
            } catch (e) { }
        }

        function hideSuccessToast() {
            document.getElementById('successToastOverlay').classList.remove('show');
            document.getElementById('successToast').classList.remove('show');
        }

        // ========== Actions ==========
        function selectFile(type) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'select_file', type: type
            }));
        }

        function selectFolder(type) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'select_folder', type: type
            }));
        }

        function startGenerate() {
            if (!currentProjectConfig) {
                showMiniToast('âš ï¸', 'æç¤º', 'è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning');
                return;
            }

            // Collect checked folders
            const checkboxes = document.querySelectorAll('#dataSourceList input[type="checkbox"]:checked');

            if (checkboxes.length === 0) {
                showMiniToast('âš ï¸', 'æç¤º', 'è¯·è‡³å°‘å‹¾é€‰ä¸€ä¸ªæ•°æ®æºæ–‡ä»¶å¤¹', 'warning');
                return;
            }

            const sourcePaths = Array.from(checkboxes).map(cb => {
                return currentProjectConfig.RootPath + "\\" + cb.value;
            });

            const conf = {
                action: 'generate',
                sourcePaths: sourcePaths,
                targetPath: document.getElementById('targetPath').value,
                classes: currentProjectConfig.Classes,

                modelSize: document.getElementById('modelSize').value,
                imgSize: parseInt(document.getElementById('imgSize').value),
                epochs: parseInt(document.getElementById('epochs').value),
                batchSize: parseInt(document.getElementById('batchSize').value),
                patience: parseInt(document.getElementById('patience').value),
                workers: parseInt(document.getElementById('workers').value),
                gpuIndex: document.getElementById('gpuIndex').value,
                enableP2: document.getElementById('enableP2').checked,
                autoFixImage: document.getElementById('autoFixImage').checked
            };

            window.chrome.webview.postMessage(JSON.stringify(conf));
        }

        function startTraining() {
            switchTab('monitor');
            addLog("æ­£åœ¨å‘é€è®­ç»ƒè¯·æ±‚...", "info");
            trainStartTime = 0;
            document.getElementById('progressETA').innerText = '';

            const workDir = document.getElementById('targetPath').value;

            document.getElementById('btnStartTrain').disabled = true;
            document.getElementById('btnStopTrain').disabled = false;

            // New Params
            const customOnnxName = document.getElementById('customOnnxName').value;
            const modelStoragePath = document.getElementById('modelStoragePath').value || "";

            // Save storage path if set
            if (modelStoragePath) {
                localStorage.setItem('insight_model_storage_path', modelStoragePath);
            }

            const conf = {
                action: 'start_training',
                pythonPath: document.getElementById('pythonPath').value,
                workDir: workDir,
                // Add missing params from UI that were not in original startTraining but might be needed
                // actually original startTraining only sent pythonPath and workDir, 
                // but HandleStartTraining in backend reads everything from 'data'.
                // The previous HandleGenerate used a different set. 
                // Let's ensure startTraining sends ALL params needed by backend HandleStartTraining.
                // Re-reading HandleStartTraining in Insight.cs (lines 895+) would show what it needs.
                // Assuming backend reads from the same 'data' object.

                // Oops, looking at Insight.cs HandleStartTraining (viewed previously), it seemingly re-reads params?
                // No, HandleStartTraining (step 292 view) wasn't fully shown. 
                // But HandleGenerate (lines 392) reads params.
                // Let's assume HandleStartTraining in backend reads these too.
                // The user's original startTraining (line 1665) ONLY sent pythonPath and workDir.
                // This implies HandleStartTraining might have been reading from a 'config' or maybe the user ISN'T sending params?
                // Wait, if I scroll up to 1665 in existing file, it only sends pythonPath and workDir.
                // This is weird. Let me assume I need to send everything.
                modelSize: document.getElementById('modelSize').value,
                imgSize: parseInt(document.getElementById('imgSize').value) || 640,
                epochs: parseInt(document.getElementById('epochs').value) || 300,
                batchSize: parseInt(document.getElementById('batchSize').value) || 16,
                patience: parseInt(document.getElementById('patience').value) || 50,
                workers: parseInt(document.getElementById('workers').value) || 8,
                gpuIndex: document.getElementById('gpuIndex').value || "0",
                enableP2: document.getElementById('enableP2').checked,
                autoFixImage: document.getElementById('autoFixImage').checked,
                onnxName: customOnnxName,
                modelStoragePath: modelStoragePath,
                classes: (currentProjectConfig && currentProjectConfig.Classes) ? currentProjectConfig.Classes : []
            };

            console.log("Sending training config:", conf);
            window.chrome.webview.postMessage(JSON.stringify(conf));
        }

        function stopTraining() {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'stop_training'
            }));
        }

        // --- Model Management Logic ---

        function getModelStoragePath() {
            // Priority 1: User-specified custom path
            let path = document.getElementById('modelStoragePath').value;

            // Priority 2: Saved in localStorage
            if (!path) {
                path = localStorage.getItem('insight_model_storage_path');
            }

            // Priority 3: Current project's dataset folder (where training outputs go)
            if (!path && currentProjectConfig && currentProjectConfig.RootPath) {
                path = currentProjectConfig.RootPath + "\\dataset";
            }

            // Priority 4: targetPath input (only works when on Config tab)
            if (!path) {
                path = document.getElementById('targetPath').value;
            }

            console.log("[getModelStoragePath] Resolved path:", path);
            return path;
        }

        // === Simplified Training History ===

        function loadTrainingHistory() {
            console.log("[loadTrainingHistory] Requesting training history...");
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_training_history'
            }));
        }

        function renderTrainingHistory(entries) {
            const tbody = document.getElementById('trainingHistoryBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!entries || entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #aaa; padding: 30px;">æš‚æ— è®­ç»ƒè®°å½•ã€‚å®Œæˆä¸€æ¬¡è®­ç»ƒåè¿™é‡Œä¼šæ˜¾ç¤ºå†å²ã€‚</td></tr>';
                return;
            }

            // Sort by date descending (newest first)
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            entries.forEach(entry => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';

                // Project Name
                const projectName = entry.projectName || 'Unknown';

                // Config: modelSize, imgSize, epochs, batchSize
                const configStr = `${entry.modelSize || '-'} | ${entry.imgSize || 640}px | ${entry.epochs || '-'}e | B${entry.batchSize || '-'}`;

                // Training Metrics: Loss / mAP50 / mAP50-95
                const loss = entry.finalLoss !== undefined ? entry.finalLoss.toFixed(3) : '-';
                const map50 = entry.mAP50 !== undefined ? (entry.mAP50 * 100).toFixed(1) + '%' : '-';
                const map5095 = entry.mAP5095 !== undefined ? (entry.mAP5095 * 100).toFixed(1) + '%' : '-';
                const metricsStr = `
                    <span style="background:rgba(255,100,100,0.2); color:#ff6b6b; padding:2px 6px; border-radius:4px; margin-right:4px; font-size:11px;">Loss: ${loss}</span>
                    <span style="background:rgba(0,212,255,0.2); color:#0be881; padding:2px 6px; border-radius:4px; margin-right:4px; font-size:11px;">mAP50: ${map50}</span>
                    <span style="background:rgba(100,200,255,0.2); color:#74b9ff; padding:2px 6px; border-radius:4px; font-size:11px;">mAP50-95: ${map5095}</span>
                `;

                // Date
                const dateStr = entry.date || '-';

                // Build row HTML (without button)
                tr.innerHTML = `
                    <td style="padding: 12px; font-weight: 500;">${projectName}</td>
                    <td style="padding: 12px; font-size: 12px; color: #aaa;">${configStr}</td>
                    <td style="padding: 12px;">${metricsStr}</td>
                    <td style="padding: 12px; font-size: 12px; color: #aaa;">${dateStr}</td>
                    <td style="padding: 12px; text-align: center;" class="action-cell"></td>
                `;

                // Create button programmatically to avoid escaping issues
                const modelPath = entry.modelPath || '';
                console.log("[renderTrainingHistory] Creating button for path:", modelPath);
                const actionCell = tr.querySelector('.action-cell');
                console.log("[renderTrainingHistory] Found action cell:", actionCell);

                if (modelPath && actionCell) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-secondary btn-icon';
                    btn.title = 'æ‰“å¼€æ¨¡å‹æ‰€åœ¨æ–‡ä»¶å¤¹';
                    btn.textContent = 'ğŸ“‚';
                    // Store path as data attribute
                    btn.dataset.path = modelPath;
                    btn.onclick = function (e) {
                        var path = e.target.dataset.path;
                        window.chrome.webview.postMessage(JSON.stringify({
                            action: 'open_model_folder',
                            path: path
                        }));
                    };
                    actionCell.appendChild(btn);
                } else {
                    if (actionCell) actionCell.textContent = '-';
                }

                tbody.appendChild(tr);
            });
        }

        function openModelFolder(modelPath) {
            console.log("[openModelFolder] Called with:", modelPath);
            addLog("æ­£åœ¨æ‰“å¼€æ–‡ä»¶å¤¹: " + modelPath, "info");
            if (!modelPath) {
                addLog("è·¯å¾„ä¸ºç©ºï¼Œæ— æ³•æ‰“å¼€", "warning");
                return;
            }
            try {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'open_model_folder',
                    path: modelPath
                }));
                console.log("[openModelFolder] Message sent to backend");
            } catch (err) {
                console.error("[openModelFolder] Error:", err);
                addLog("å‘é€æ¶ˆæ¯å¤±è´¥: " + err.message, "error");
            }
        }


        function refreshModels() {
            const path = getModelStoragePath();
            console.log("[refreshModels] Final path:", path);

            if (!path) {
                console.warn("[refreshModels] No path available, cannot load models");
                addLog("æ— æ³•åŠ è½½æ¨¡å‹åˆ—è¡¨: è¯·å…ˆé€‰æ‹©é¡¹ç›®æˆ–è®¾ç½®æ¨¡å‹å­˜å‚¨è·¯å¾„", "warning");
                return;
            }

            // Sync UI
            document.getElementById('currentModelPath').value = path;
            document.getElementById('modelStoragePath').value = path;

            console.log("[refreshModels] Sending get_models request for:", path);
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_models',
                path: path
            }));
        }

        function filterModels() {
            const query = document.getElementById('modelSearch').value.toLowerCase();
            const filtered = currentModelList.filter(m => m.name.toLowerCase().includes(query));
            renderModelList(filtered);
        }

        function renderModelList(models) {
            const tbody = document.getElementById('modelTableBody');
            tbody.innerHTML = '';

            // Update Header if needed (We need to insert header rows dynamically or assume fixed HTML)
            // Ideally we should update the HTML structure of the table too.
            // But let's cheat and update the THEAD via JS or just rewrite row content carefully.
            // Better: Let's assume user accepts I change the THEAD in HTML too. 
            // I will target the THEAD in a separate edit or just force it here if I can ? 
            // No, renderModelList only touches TBODY.
            // I will use a separate replacement for the HTML structure.
            // For now, let's look at the JS logic assuming the columns are:
            // Name | Config | Labels | Time | Actions

            if (!models || models.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #aaa; padding: 20px;">No models found. Train one to see history!</td></tr>';
                return;
            }

            models.forEach(model => {
                const tr = document.createElement('tr');

                // --- Metadata Parsing ---
                let configStr = '<span style="color:#aaa;">-</span>';
                let labelsStr = '<span style="color:#aaa;">-</span>';
                let sizeStr = model.size;

                if (model.metadata && model.metadata.paramsData) {
                    const p = model.metadata.paramsData;
                    // Format: v8s | 640 | Ep:300 | B:16
                    configStr = `<span class="badge" style="background:var(--bg-card); border:1px solid var(--border-color); color:var(--text-main); font-family:Consolas;">${p.ModelSize}</span> 
                                 <span style="color:var(--text-sub); font-size:11px;">${p.ImgSize}px</span>
                                 <span style="color:var(--text-sub); font-size:11px;">Ep:${p.Epochs}</span>`;

                    // Classes
                    if (p.Classes && p.Classes.length > 0) {
                        labelsStr = p.Classes.map(c => `<span class="badge" style="background:rgba(0,210,255,0.1); color:var(--primary); margin-right:4px;">${c}</span>`).join('');
                    }
                }

                // Name Column (Icon + Name)
                const nameHtml = `<div style="display:flex; align-items:center; gap:8px;">
                                    <span style="font-size:16px;">ğŸ“¦</span>
                                    <div>
                                        <div style="font-weight:bold; font-size:13px;">${model.name}</div>
                                        <div style="font-size:11px; color:#aaa;">${model.size}</div>
                                    </div>
                                  </div>`;

                tr.innerHTML = `
                    <td style="padding: 12px;">${typeBadge}</td>
                    <td style="padding: 12px;">${model.size}</td>
                    <td style="padding: 12px;">${model.date}</td>
                    <td style="padding: 12px; text-align: right; display:flex; gap:6px; justify-content:flex-end;">${actions}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openModelFolder() {
            const path = getModelStoragePath();
            if (path) {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'open_output',
                    path: path
                }));
            }
        }

        function renameModel(oldName) {
            const newName = prompt("è¯·è¾“å…¥æ–°åç§° (æ— éœ€åç¼€):", oldName.replace(/\.(onnx|pt)$/i, ""));
            if (newName && newName !== oldName.replace(/\.(onnx|pt)$/i, "")) {
                const ext = oldName.split('.').pop();
                const fullName = newName.endsWith('.' + ext) ? newName : newName + '.' + ext;

                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'rename_model',
                    path: getModelStoragePath(),
                    oldName: oldName,
                    newName: fullName
                }));
            }
        }

        function deleteModel(fileName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ ${fileName} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'delete_model',
                    path: getModelStoragePath(),
                    fileName: fileName
                }));
            }
        }

        function convertModel(fileName) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'convert_model',
                sourcePath: getModelStoragePath() + "\\" + fileName,
                targetDir: getModelStoragePath(),
                pythonPath: document.getElementById('pythonPath').value
            }));
        }

        function openOutputFolder() {
            const p = document.getElementById('targetPath').value;

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'open_output', path: p
            }));
        }

        // Create Project Modal
        function openCreateProjectModal() {
            document.getElementById('createProjectModal').style.display = 'flex';
        }

        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').style.display = 'none';
        }

        function createProject() {
            const name = document.getElementById('newProjectName').value;
            const root = document.getElementById('newProjectRoot').value;
            const classes = document.getElementById('newProjectClasses').value;

            if (!name || !root) {
                showMiniToast('âš ï¸', 'æç¤º', 'é¡¹ç›®åç§°å’Œæ ¹ç›®å½•ä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'create_project',
                name: name,
                rootPath: root,
                classes: classes
            }));

            closeCreateProjectModal();
        }

        function deleteProject() {
            if (!currentProjectConfig) return;
            const idx = document.getElementById('projectSelect').selectedIndex;
            if (idx < 0) return;

            if (confirm('ç¡®å®šè¦åˆ é™¤å½“å‰é¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä»…ç§»é™¤åˆ—è¡¨é¡¹ï¼Œä¸ä¼šåˆ é™¤ç¡¬ç›˜æ–‡ä»¶ã€‚')) {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'delete_project',
                    index: idx
                }));
            }
        }

        // Defect Modal
        function openAugmentModal() {
            document.getElementById('augmentModal').style.display = 'flex';
        }

        function closeAugmentModal() {
            document.getElementById('augmentModal').style.display = 'none';
        }

        function startAugmentation() {
            const conf = {
                action: 'defect_augmentation',
                sourcePath: document.getElementById('augmentSourcePath').value,
                holeAssetsPath: document.getElementById('holeAssetsPath').value,
                mutationRate: parseInt(document.getElementById('mutationRate').value)
            };

            window.chrome.webview.postMessage(JSON.stringify(conf));
        }

        // Helper
        function selectFolder(type) {
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'select_folder',
                type: type
            }));
        }

        function startToolConversion() {
            const src = document.getElementById('toolSourcePath').value;
            const tgt = document.getElementById('toolTargetPath').value;

            if (!src || !tgt) {
                showMiniToast('âš ï¸', 'æç¤º', 'è¯·å…ˆé€‰æ‹©æºæ–‡ä»¶å¤¹å’Œç›®æ ‡è·¯å¾„', 'warning');
                return;
            }

            // Clear log
            document.getElementById('toolConsole').innerHTML = '<div class="log-item"><span class="log-time">[System]</span>Starting conversion...</div>';

            window.chrome.webview.postMessage(JSON.stringify({
                action: 'convert_tool',
                sourcePath: src,
                targetPath: tgt
            }));
        }

        // ========== Python Path Persistence ==========
        const DEFAULT_PYTHON_PATH = 'C:\\conda_envs\\yolo\\python.exe';

        function loadPythonPath() {
            // è¯·æ±‚åç«¯åŠ è½½é»˜è®¤è·¯å¾„
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'get_default_python_path'
            }));
        }

        function savePythonPath(path) {
            // ä¸´æ—¶ä¿å­˜ï¼ˆå¯é€‰ï¼Œç›®å‰ä¸åšæŒä¹…åŒ–ï¼‰
        }

        function saveAsDefaultPythonPath() {
            var currentPath = document.getElementById('pythonPath').value;
            if (!currentPath || currentPath.trim() === '') {
                showMiniToast('âš ï¸', 'è®¾ç½®å¤±è´¥', 'è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„ Python ç¯å¢ƒè·¯å¾„', 'warning');
                return;
            }
            // é€šè¿‡åç«¯ä¿å­˜ä¸ºé»˜è®¤åœ°å€
            window.chrome.webview.postMessage(JSON.stringify({
                action: 'save_default_python_path',
                path: currentPath
            }));
        }

        function showMiniToast(icon, title, message, type) {
            // ç§»é™¤æ—§çš„ toast
            var oldToast = document.querySelector('.mini-toast');
            if (oldToast) oldToast.remove();

            // åˆ›å»ºæ–°çš„ toast
            var toast = document.createElement('div');
            toast.className = 'mini-toast';
            if (type === 'error') {
                toast.style.background = 'linear-gradient(135deg, #E53935, #EF5350)';
            } else if (type === 'warning') {
                toast.style.background = 'linear-gradient(135deg, #FB8C00, #FFA726)';
            }
            toast.innerHTML = '<div class="mini-toast-icon">' + icon + '</div>' +
                '<div class="mini-toast-content">' +
                '<div class="mini-toast-title">' + title + '</div>' +
                '<div class="mini-toast-message">' + message + '</div>' +
                '</div>';
            document.body.appendChild(toast);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(function () { toast.classList.add('show'); }, 50);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(function () {
                toast.classList.remove('show');
                setTimeout(function () { toast.remove(); }, 400);
            }, 3000);
        }

        // Init
        setTimeout(() => {
            loadProjects();
            loadPythonPath();
        }, 500); // Trigger auto load
    </script>
</body>

</html>