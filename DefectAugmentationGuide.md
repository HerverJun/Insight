# 🛠️ 缺陷样本增强 (Hard Negative Synthesis) 功能说明文档

## 1. 功能简介
本功能用于解决工业质检中**“缺陷样本难收集”**的痛点。
通过读取“良品”图片，定位其中的螺钉坐标，并使用预设的“空螺孔”素材进行覆盖融合，人为制造“漏打螺钉”的缺陷样本。此类样本被称为“硬负样本 (Hard Negative)”，能有效提升模型对漏打缺陷的识别能力。

---

## 2. 素材准备指南 (关键步骤)

### Q: “空螺孔”素材从哪里来？
**A: 是的，需要您使用 PS (Photoshop) 或其他修图工具制作。**

### 制作步骤：
1.  **取材**：从您拍摄的历史图片中，找到一张**真实的、确实没打螺钉**的图片。
2.  **截取**：使用 PS 的选区工具，将那个“黑色的螺孔”区域抠取出来。
3.  **去背 (重要)**：
    *   **只保留孔洞和边缘阴影**。
    *   将孔洞周围的金属背景、反光区域全部**删除或设为透明**。
    *   确保图片是通过 **透明底** 保存的。
4.  **保存**：必须保存为 **`.png`** 格式（因为它支持透明通道）。

### 素材要求：
*   **格式**：必须是 `.png`。
*   **通道**：必须包含 Alpha 透明通道 (RGBA)。
*   **分辨率**：
    *   **建议尺寸**：**128x128 像素** 或 **256x256 像素**。
    *   **说明**：程序会自动将素材缩放以适应目标螺钉的大小。因此，素材图片**宁大勿小**。如果素材太小（如 20x20），放大后会模糊；如果素材较大，缩小后依然清晰。
*   **数量**：建议准备 **3-5 张** 不同形态（如不同光照、不同角度）的螺孔素材，程序会随机选用，增加样本的多样性。

---

## 3. 数据集准备

本功能支持两种格式的源数据：

1.  **LabelMe 格式 (推荐)**：
    *   包含 `.jpg` 图片和对应的 `.json` 标注文件。
    *   无需预先转换，直接使用即可。
2.  **YOLO 格式**：
    *   包含 images 文件夹和 labels 文件夹（`.txt`）。

---

## 4. 使用流程

1.  **进入功能**：
    *   打开 Insight 软件，在左侧“1. 数据源设置”区域，点击 **`🛠️ 缺陷样本增强`** 按钮。
2.  **设置路径**：
    *   **源文件夹**：选择包含良品图片和标签的文件夹。
    *   **素材文件夹**：选择您存放做好的“空螺孔 PNG”的文件夹。
3.  **设定比例**：
    *   调整 **变异率 (Mutation Rate)** 滑块。
    *   推荐值：**20% - 30%**。
    *   *(注：30% 表示如果有 100 张良品，程序会随机挑选约 30 张进行篡改)*
4.  **执行生成**：
    *   点击“开始生成”，等待进度条跑完。
    *   生成的增强数据集会保存在源文件夹同级的 `_Augmented` 目录下。

---

## 5. 常见问题 (FAQ)

*   **Q: 素材放进去后生成的图片不仅有孔，还有一块正方形的黑边？**
    *   A: 这是因为您的 PNG 素材没有**去背**。请确保在 PS 中把孔洞周围的背景删掉，变成透明网格状，而不是白色或黑色背景。
*   **Q: 生成的标签文件也是 JSON 吗？**
    *   A: 不，为了方便直接训练，增强后的数据集统一输出为 **standard YOLO (.txt)** 格式。
*   **Q: 所有的螺钉都会被覆盖吗？**
    *   A: 不会。在一张图片中，程序会**随机选择一个**螺钉进行覆盖，模拟“这就漏了一颗”的真实场景。

---

## 6. 技术原理
*   **ROI 映射**：解析标签坐标，计算出螺钉在原图中的像素区域 (Region of Interest)。
*   **Alpha Blending**：使用 `src * alpha + dst * (1 - alpha)` 算法将素材融合到原图，保证孔洞边缘与原图背景过渡自然，无锯齿感。
*   **动态缩放**：无论您的素材多大，都会自动 Resize 到目标螺钉的确切尺寸。
